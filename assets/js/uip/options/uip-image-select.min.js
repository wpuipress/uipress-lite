const{__:__,_x:_x,_n:_n,_nx:_nx}=wp.i18n;import{uipMediaLibrary}from"../classes/uip-media-library.min.js";export function moduleData(){return{props:{returnData:Function,value:Object},data:function(){return{open:!1,loading:!0,img:this.value,dynamics:this.uipData.dynamicOptions,maxUpload:this.uipData.options.maxUpload,fileTypes:this.uipData.options.uploadTypes,fileType:"",manualURL:"",uploading:!1,strings:{dynamicData:__("Dynamic data","uipress-lite"),currentValue:__("Current value","uipress-lite"),select:__("select","uipress-lite"),dataPos:__("Dynamic data position","uipress-lite"),replace:__("Replace","uipress-lite"),edit:__("Edit","uipress-lite"),upload:__("Upload","uipress-lite"),uploading:__("Uploading","uipress-lite"),library:__("Library","uipress-lite"),dynamic:__("Dynamic","uipress-lite"),chooseImage:__("Add image","uipress-lite")}}},inject:["uipData","uipress"],watch:{img:{handler(i,e){this.returnData(this.img)},deep:!0},manualURL:{handler(i,e){""!=i&&(this.removeDynamicItem(),this.img.url=i)}}},mounted:function(){this.formatInput(this.value)},methods:{formatInput(i){return void 0===i?(this.img={},this.img.url="",this.img.dynamic=!1,this.img.dynamicKey="",this.loading=!1,this.img):this.uipress.isObject(i)?"url"in i?(this.img=i,void(this.loading=!1)):(this.img.url="",this.img.dynamic=!1,this.img.dynamicKey="",this.loading=!1,this.img):(this.img={},this.img.url="",this.img.dynamic=!1,this.img.dynamicKey="",this.loading=!1,this.img)},chooseImage(i){let e=this,t=new uipMediaLibrary({multiple:!1,style:"modal",features:["stock","upload","delete"],fileTypes:["image/*"]});t.create(),t.on("uip_media_selected",function(i){i.detail.files&&(e.removeDynamicItem(),e.img.url=i.detail.files.url)})},chooseItem(i){this.img.dynamic=!0,this.img.dynamicType="img",this.img.dynamicKey=i.key,this.img.url=i.value,this.returnData({url:this.img.value,dynamic:this.img.dynamic,dynamicKey:this.img.dynamicKey,dynamicPos:this.img.dynamicPos})},removeDynamicItem(){this.img.dynamic=!1,this.img.dynamicKey="",this.img.url="",this.returnData({url:this.img.value,dynamic:this.img.dynamic,dynamicKey:this.img.dynamicKey,dynamicPos:this.img.dynamicPos})},get_url_extension:i=>i.split(/[#?]/)[0].split(".").pop().trim(),getFileTypeFromUrl(i){let e=this;if(!i||""==i)return void(e.fileType="");let t=new XMLHttpRequest;t.open("GET",i,!0),t.onreadystatechange=function(){let i=t.getResponseHeader("Content-Type");i&&(t.abort(),e.fileType=i)},t.send()},recieveDynamic(i){this.img.dynamic=!0,this.img.dynamicKey=i.key,this.img.dynamicType="img",this.img.url=i.value,this.returnData({url:this.img.value,dynamic:this.img.dynamic,dynamicKey:this.img.dynamicKey,dynamicPos:this.img.dynamicPos})},uploadImage(){let i=this,e=i.uipress.notify(__("Uploading image","uipress-lite"),"","default",!1,!0);i.uploading=!0;let t=document.getElementById("uip-image-upload").files[0];if(!this.fileTypes.includes(t.type))return i.uipress.notify(__("Unable to upload this file type","uipress-lite"),"","error",!0,!1),i.uipress.destroy_notification(e),void(i.uploading=!1);if(t.size>i.maxUpload)return i.uipress.notify(__("Image exceeds max upload size","uipress-lite"),"","error",!0,!1),i.uipress.destroy_notification(e),void(i.uploading=!1);let a=new FormData;a.append("action","uip_upload_image"),a.append("security",uip_ajax.security),a.append("image",t),a.append("file",t),fetch(uip_ajax.ajax_url,{method:"POST",body:a,ContentType:!1,processData:!1,headers:{processData:!1,"process-Data":!1}}).then(i=>i.text()).then(t=>{let a=i.uipress.uipParsJson(t);a.success?(i.removeDynamicItem(),i.img.url=a.url,i.uipress.destroy_notification(e),i.uipress.notify(__("Image uploaded","uipress-lite"),"","success",!0,!1),i.uploading=!1):(i.uipress.notify(__("Unable to handle upload","uipress-lite"),"","error",!0,!1),i.uploading=!1)}).catch(t=>{i.uipress.notify(t,"","error"),i.uipress.destroy_notification(e),i.uploading=!1})}},template:'      <div class="uip-background-muted uip-border-round uip-overflow-hidden" v-if="!loading">                <div v-if="img.url" class="uip-background-grey uip-flex uip-flex-center uip-flex-middle uip-position-relative uip-scale-in-center">          <img v-if="img.url" class="uip-max-h-120" :src="img.url">          <div v-if="img.dynamic" class="uip-position-absolute uip-top-0 uip-left-0 uip-padding-xs">            <div class="uip-padding-left-xxs uip-padding-right-xxs uip-background-primary uip-border-round uip-flex uip-gap-xxs uip-flex-center uip-text-inverse uip-cursor-pointer">              <span class="uip-icon uip-icon uip-text-l">database</span>              <span class="uip-text-xs">{{img.dynamicKey}}</span>              <span @click="removeDynamicItem()" class="uip-icon uip-text-l">backspace</span>            </div>          </div>        </div>                <div class="uip-flex uip-flex-column uip-padding-xs uip-row-gap-xs">          <div v-if="img.url" class="uip-flex uip-flex-column uip-flex-start uip-scale-in-center">            <div class="uip-no-wrap uip-text-ellipsis uip-overflow-hidden uip-max-w-100p">{{img.url.split(\'/\').pop()}}</div>            <div class="uip-text-muted" >{{getFileTypeFromUrl(img.url)}}{{fileType}}</div>          </div>          <div class="uip-flex uip-flex-row uip-flex-between uip-flex-center">            <div class="uip-flex uip-flex-row uip-gap-xs">              <dropdown pos="bottom left">                <template v-slot:trigger>                  <div v-if="img.url" class="uip-link-default uip-text-bold">{{strings.replace}}</div>                  <div v-if="!img.url" class="uip-flex uip-gap-xxs uip-flex-center">                    <div class="uip-icon uip-icon-medium">add</div>                    <div class="uip-link-default uip-text-bold">{{strings.chooseImage}}</div>                  </div>                </template>                <template v-slot:content>                  <div class="uip-padding-xs uip-flex uip-flex-column uip-row-gap-xxs uip-w-100 uip-overflow-hidden">                    <label class="">                      <div class="uip-flex uip-flex-row uip-gap-xs uip-link-default uip-flex-center">                        <div v-if="!uploading" class="uip-icon uip-text-l uip-icon-medium">file_upload</div>                        <div v-if="uploading" class="uip-load-spinner-dark"></div>                        <div v-if="!uploading" class="">{{strings.upload}}</div>                        <div v-if="uploading" class="">{{strings.uploading}}</div>                      </div>                      <input hidden :accept="fileTypes.toString()" type="file" single="" id="uip-image-upload" @change="uploadImage()">                    </label>                    <div class="uip-flex uip-flex-row uip-gap-xs uip-link-default uip-flex-center" @click="chooseImage()">                      <div class="uip-icon uip-text-l uip-icon-medium">photo_library</div>                      <div class="">{{strings.library}}</div>                    </div>                    <dropdown pos="bottom left">                      <template v-slot:trigger>                        <div class="uip-flex uip-flex-row uip-gap-xs uip-link-default uip-flex-center">                          <div class="uip-icon uip-text-l uip-icon-medium">database</div>                          <div class="">{{strings.dynamic}}</div>                        </div>                      </template>                      <template v-slot:content>                        <dynamic-data-list type="image" :returnData="recieveDynamic"></dynamic-data-list>                      </template>                    </dropdown>                    <div class="uip-flex uip-flex-row uip-gap-xs uip-link-default uip-flex-center">                      <div class="uip-icon uip-text-l uip-icon-medium">link</div>                      <input class="uip-blank-input uip-max-w-100p uip-overflow-hidden" placeholder="URL..." v-model="manualURL">                    </div>                  </div>                </template>              </dropdown>            </div>            <div v-if="img.url" class="uip-icon uip-text-l uip-icon-medium uip-link-danger" @click="removeDynamicItem()">delete</div>          </div>        </div>      </div>'}};