const{__:__}=wp.i18n;import{maybeForceReload,stripUIPparams}from"../../v3.5/utility/functions.min.js";export default{props:{display:String,name:String,block:Object},data(){return{frame:!1,loading:!0,fullScreen:!1,breadCrumbs:[],startPage:this.returnAdminPage,cornertickle:!1,currentURL:!1,rendered:!1,scrollOver:!0,mounted:!1,updatingBrowserWindow:!1}},inject:["uiTemplate"],watch:{"uipApp.data.themeStyles":{handler(e,t){this.injectStyles()},deep:!0},"uiTemplate.globalSettings.options.advanced.css":{handler(e,t){this.injectStyles()},deep:!0}},mounted(){this.mountProductionFunctions(),this.mountMainWatchers(),this.mounted=!0},beforeUnmount(){this.removeWatchers()},computed:{returnStartPage(){return"prod"==this.uiTemplate.display?window.location.href:this.returnAdminPage},returnLoadingStyle(){if(!this.rendered||this.loading)return"opacity:0"},returnHomePage(){return this.getBlockOption("loginRedirect","value",!1)},showLoader(){return this.getBlockOption("hideLoader","value",!0)},disableFullScreen(){return this.getBlockOption("disableFullScreen","value",!0)},returnClasses(){let e="";return this.fullScreen&&(e+="uip-fullscreen-mode uip-scale-in-bottom-right uip-z-index-9"),e},returnTemplateCSS(){const e=this.uiTemplate.globalSettings.options;if(void 0!==e&&"advanced"in e)return"css"in e.advanced?e.advanced.css:void 0},returnAdminPage(){return this.hasNestedPath(this.uipApp.data,"dynamicOptions","viewadmin","value")}},methods:{returnPublicMethods:()=>["reloadFrame"],reloadFrame(){const e=this.$refs.contentframe;e&&e.contentWindow.location.reload()},removeWatchers(){window.removeEventListener("message",this.handleFrameMessages,!1),window.removeEventListener("popstate",this.handleHashChanges,!1),window.removeEventListener("hashchange",this.handleHashChanges,!1),document.removeEventListener("uipress/app/breadcrumbs/update",this.handleBreadCrumbChange,{once:!1}),document.removeEventListener("uip_update_frame_url",this.handleURLchangeRequest,{once:!1}),document.removeEventListener("keydown",this.handleEscapeFullScreen),document.removeEventListener("uipress/app/window/fullscreen",this.toggleFullScreen)},mountMainWatchers(){document.addEventListener("uipress/app/breadcrumbs/update",this.handleBreadCrumbChange,{once:!1}),document.addEventListener("uipress/app/window/fullscreen",this.toggleFullScreen),document.addEventListener("uip_update_frame_url",this.handleURLchangeRequest,{once:!1}),this.iframeURLChange(this.$refs.contentframe,this.handleFrameURLChange)},mountProductionFunctions(){"prod"==this.uiTemplate.display&&(window.addEventListener("message",this.handleFrameMessages,!1),window.addEventListener("popstate",this.handleHashChanges,!1),window.addEventListener("hashchange",this.handleHashChanges,!1))},handleFrameURLChange(e){const t=this.$refs.contentframe;this.initiateLoading(),this.currentURL=e;const n=new URL(e);if(maybeForceReload(n),this.shouldReloadPage(n))return window.location.assign(n);this.handleIframeContentChanges(t,n,e)},dynamicLoadingDisabled(e){const t="prod"==this.uiTemplate.display;if("undefined"!=typeof UIPdisableDynamicLoading){const n=!(!UIPdisableDynamicLoading||!t),i=stripUIPparams(e);n&&window.location.assign(i)}},initiateLoading(){document.dispatchEvent(new CustomEvent("uipress/app/page/load/start")),this.loading=!0;setTimeout(()=>this.loading=!1,2e3)},shouldReloadPage(e){return"undefined"!=typeof UIPfrontEndReload&&UIPfrontEndReload&&"builder"!==this.uiTemplate.display&&!e.href.includes(this.returnAdminPage)},handleIframeContentChanges(e,t,n){const i=e.contentWindow.document.querySelectorAll("#adminmenu a[aria-current='page']");let s=n;i[0]&&(s=i[0].getAttribute("href")),this.updateActiveLink(s),this.injectStyles(),this.loading=!1},async handleIframeLoad(e){const t=this.$refs.contentframe;if(!t)return;const n=t.contentWindow.location.href;if(!await this.checkPageLoaded())return window.location.assign(this.currentURL);this.mountFrameWatchers(),this.getAdminPageTitle(),this.checkForUserFullSreen(n),this.loading=!1,this.rendered=!0;const i=t.contentDocument.title;i&&(document.title=i),"prod"==this.uiTemplate.display&&this.updateBrowserAddress(t.contentWindow.location.href),document.dispatchEvent(new CustomEvent("uipress/app/page/load/finish"))},getAdminPageTitle(){const e=this.$refs.contentframe;if(!e)return;const t=e.contentWindow.document.querySelector("#uip-admin-page-title");if(!t)return;const n=t.getAttribute("data-title");this.uipApp.data.dynamicOptions.adminPageTitle.value=n},async checkPageLoaded(){try{return this.$refs.contentframe.contentWindow.title,!0}catch(e){return!1}},handleURLchangeRequest(e){let t=e.detail.url;this.loading=!0;if(setTimeout(()=>this.loading=!1,2e3),this.$refs.contentframe.contentWindow)try{this.$refs.contentframe.contentWindow.location.assign(t)}catch(e){this.$refs.contentframe.src=t}},handleBreadCrumbChange(e){this.breadCrumbs=e.detail.crumbs},handleFrameMessages(e){if(!e.data)return;const t="uip_request_fullscreen"===e.data.eventName,n="uip_exit_fullscreen"===e.data.eventName;this.$refs.frameContainer;t&&!this.isFullScreen()&&this.setFullScreen(),n&&this.isFullScreen()&&this.removeFullScreen()},async handleHashChanges(e){this.isObject(e.state)&&e.state.blockEvent||window.location.href!=this.startPage&&this.$refs.contentframe.contentWindow.location.assign(window.location.href)},updateStartPage(){const{dynamicOptions:e}=this.uipApp.data,t=e.viewadmin.value;if(this.returnHomePage&&(this.startPage===t||this.startPage===`${t}#/`)){/^(?:[a-z+]+:)?\/\//i.test(this.returnHomePage)?this.startPage=this.returnHomePage:this.startPage=`${t}${this.returnHomePage}`}this.navigateFrameToStartPage()},getBlockOption(e,t,n){const i=this.get_block_option(this.block,"block",e,!0);return this.isObject(i)?t in i?i[t]:n:i||n},navigateFrameToStartPage(){let e=new URL(this.startPage);this.$refs.contentframe.contentWindow.location.replace(e),this.updateActiveLink(this.startPage)},checkForUserFullSreen(e){if("undefined"!=typeof UIPFullscreenUserPages&&UIPFullscreenUserPages&&"builder"!=this.enviroment&&Array.isArray(UIPFullscreenUserPages))for(let t of UIPFullscreenUserPages)(e==t||e.includes(t))&&this.setFullScreen()},findClosestLink(e){for(;e&&e!==document;){if("A"===e.tagName)return e;e=e.parentNode}return null},mountFrameWatchers(){const e=this.$refs.contentframe,t=e=>{const t=e.newURL;this.updateBrowserAddress(t)};e.contentWindow.document.addEventListener("click",e=>{const t=this.findClosestLink(e.target);t&&(t.closest(".edit-post-visual-editor")||this.handleInsideFrameLink(t));return this.forceClickEvent()}),e.contentWindow.addEventListener("hashchange",t),e.contentWindow.addEventListener("uip-frame-hash-change",t),e.contentWindow.document.addEventListener("uipress/app/darkmode/toggle",()=>{document.dispatchEvent(new CustomEvent("uipress/app/darkmode/toggle"))}),e.contentWindow.document.addEventListener("uipress/blocks/adminmenu/togglecollapse",()=>{document.dispatchEvent(new CustomEvent("uipress/blocks/adminmenu/togglecollapse"))}),e.contentWindow.document.addEventListener("uipress/app/window/fullscreen",()=>{document.dispatchEvent(new CustomEvent("uipress/app/window/fullscreen"))})},handleInsideFrameLink(e){const t=e.href;if("_blank"===(!!e.target&&e.target.toLowerCase()))return;if(!t)return;if(t.startsWith("#"))return;this.dynamicLoadingDisabled(t);if(!/^(?:[a-z+]+:)?\/\//i.test(t))return;const n=this.extractDomain(this.uipApp.data.options.domain);if(t.includes("googlesitekit_proxy_setup_start"))return window.location.href=t;t.includes(n)||(window.location.href=t)},extractDomain(e){const t=new URL(e),n=t.hostname.split(".");return n.length<=2?t.hostname:n.slice(-2).join(".")},async updateBrowserAddress(e){if(!(e=e?e.toLowerCase():e)||"about:blank"===e)return;let t=e?decodeURIComponent(e):e;if(t===window.location.href)return;setTimeout(()=>{try{history.pushState({blockEvent:!0},null,t)}catch(e){}},600)},isFullScreen(){return this.$refs.frameContainer.classList.contains("uip-fullscreen-mode")},toggleFullScreen(){this.isFullScreen()?this.removeFullScreen():this.setFullScreen()},setFullScreen(){this.$refs.frameContainer.classList.add("uip-fullscreen-mode","uip-scale-in-bottom-right"),document.addEventListener("keydown",this.handleEscapeFullScreen)},removeFullScreen(){this.$refs.frameContainer.classList.remove("uip-fullscreen-mode","uip-scale-in-bottom-right"),document.removeEventListener("keydown",this.handleEscapeFullScreen)},handleEscapeFullScreen(e){"INPUT"!==e.target.tagName&&("Escape"!==e.key&&27!==e.keyCode||this.removeFullScreen())},injectStyles(){const e=this.$refs.contentframe;if("prod"===this.uiTemplate.display)return;const t=this.uipApp.data.themeStyles,n=e.contentWindow.document.querySelector("#uip-theme-styles");if(!n)return;let i='html[data-theme="light"]{';for(const e in t){const n=t[e];n.value&&(i+=`${n.name}:${n.value};`)}i+="}";let s='html[data-theme="dark"]{';for(const e in t){const n=t[e];n.darkValue&&(s+=`${n.name}:${n.darkValue};`)}s+="}";const a=this.returnTemplateCSS;n.innerHTML=i+s+a},injectCSS(){const e=this.$refs.contentframe.contentWindow.document.getElementById("uip-theme-styles");if(!e)return;const t=this.returnTemplateCSS;e.innerText=t},iframeURLChange(e,t){let n=null;const i=()=>{if(!e.contentWindow)return;let i="";try{i=e.contentWindow.location.href}catch(e){return}this.compareURLsWithoutHash(i,n)||(t(i),n=i)},s=()=>{setTimeout(i,0)},a=()=>{e.contentWindow.removeEventListener("unload",s),e.contentWindow.addEventListener("unload",s)};e.addEventListener("load",()=>{a(),i()}),a()},compareURLsWithoutHash(e,t){if(!e||!t)return!1;const n=new URL(e),i=new URL(t);return n.hash="",i.hash="",n.href===i.href},forceClickEvent(){this.$refs.frameContainer.click()}},template:'\n    \n    <div ref="frameContainer" class="uip-flex uip-flex-column uip-overflow-hidden uip-content-frame uip-overflow-hidden uip-position-relative" \n    :class="returnClasses" @mouseenter="scrollOver = true;" @keydown.esc="removeFullScreen" tabindex="1">\n    \n      <div class="uip-position-relative" v-if="!showLoader">\n        <div ref="loader" :class="block.uid" class="uip-ajax-loader" v-if="loading">\n        <div :class="block.uid" class="uip-loader-bar"></div>\n        </div>\n      </div>\n      \n      <iframe :style="returnLoadingStyle" :src="returnStartPage" \n      \n      ref="contentframe" \n      @load="handleIframeLoad"\n      style="transition:opacity 0.3s ease-in-out"\n      class="uip-page-content-frame uip-background-default uip-scrollbar uip-w-100p uip-flex-grow" \n      :class="{\'uip-no-select\' : uiTemplate.display != \'prod\' && !uiTemplate.isPreview}"></iframe>\n       \n      <div @mouseover="cornertickle = true" @mouseleave="cornertickle = false" class="uip-position-absolute uip-text-muted uip-top-0 uip-right-0 uip-cursor-pointer uip-flex uip-flex-column uip-flex-middle uip-padding-xs" v-if="!disableFullScreen">\n      \n        <div @click="toggleFullScreen()" v-if="cornertickle" class="uip-border-box uip-background-muted uip-text-muted uip-padding-xxxs uip-link-muted hover:uip-background-grey uip-flex uip-flex-column uip-flex-middle uip-fade-in uip-shadow-small uip-border-round" style="pointer-events: all">\n        <span v-if="isFullScreen()" class="uip-icon uip-text-l uip-slide-in-right uip-line-height-1">fullscreen_exit</span>\n        <span v-if="!isFullScreen()" class="uip-icon uip-text-l uip-line-height-1">fullscreen</span>\n        </div>\n        \n      </div>\n      \n      <template v-else>\n        \n        <component v-if="disableFullScreen" is="style">\n        .uip-fullscreen-toggle {\n         display:none; \n        }\n        .uip-fullscreen-mode .uip-fullscreen-toggle {\n         display:block; \n        }\n        </component>\n        \n        <div @mouseover="cornertickle = true" @mouseleave="cornertickle = false" class="uip-position-absolute uip-text-muted uip-top-0 uip-right-0 uip-cursor-pointer uip-flex uip-flex-column uip-flex-middle uip-padding-xs" v-if="!disableFullScreen">\n        \n        <div @click="toggleFullScreen()" v-if="cornertickle" class="uip-border-box uip-background-muted uip-text-muted uip-padding-xxxs uip-link-muted hover:uip-background-grey uip-flex uip-flex-column uip-flex-middle uip-fade-in uip-shadow-small uip-border-round" style="pointer-events: all">\n          <span v-if="isFullScreen()" class="uip-icon uip-text-l uip-slide-in-right uip-line-height-1">fullscreen_exit</span>\n          <span v-if="!isFullScreen()" class="uip-icon uip-text-l uip-line-height-1">fullscreen</span>\n        </div>\n        \n        </div>\n      \n      </template>\n      \n    </div>\n    '};