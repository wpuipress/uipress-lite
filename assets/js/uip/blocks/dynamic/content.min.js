const{__:__}=wp.i18n;import{maybeForceReload,stripUIPparams}from"../../v3.5/utility/functions.min.js";export default{props:{display:String,name:String,block:Object},data(){return{frame:!1,loading:!0,fullScreen:!1,breadCrumbs:[],startPage:this.returnAdminPage,cornertickle:!1,currentURL:!1,rendered:!1,scrollOver:!0}},inject:["uiTemplate"],watch:{"uipApp.data.themeStyles":{handler(e,t){this.injectStyles()},deep:!0},"uiTemplate.globalSettings.options.advanced.css":{handler(e,t){this.injectStyles()},deep:!0}},mounted(){this.mountProductionFunctions(),this.mountMainWatchers()},beforeUnmount(){this.removeWatchers()},computed:{returnStartPage(){if("prod"==this.uiTemplate.display)return;const e=this.returnAdminPage;return this.formatRequiredParams(e)},returnLoadingStyle(){if(!this.rendered)return"opacity:0"},returnHomePage(){return this.getBlockOption("loginRedirect","value",!1)},returnTheme(){return this.getBlockOption("disableTheme","value",!1)},returnNotices(){let e=this.getBlockOption("hidePluginNotices","value",!1);return JSON.stringify(this.uiTemplate.content).includes("site-notifications")&&(e=!0),e},hideLoader(){return this.getBlockOption("hideLoader","value",!0)},returnScreen(){return this.getBlockOption("hideScreenOptions","value",!0)},returnHelp(){return this.getBlockOption("hideHelpTab","value",!0)},disableFullScreen(){return this.getBlockOption("disableFullScreen","value",!0)},returnClasses(){let e="";return this.fullScreen&&(e+="uip-fullscreen-mode uip-scale-in-bottom-right uip-z-index-9"),e},returnTemplateCSS(){const e=this.uiTemplate.globalSettings.options;if(void 0!==e&&"advanced"in e)return"css"in e.advanced?e.advanced.css:void 0},returnAdminPage(){return this.hasNestedPath(this.uipApp.data,"dynamicOptions","viewadmin","value")}},methods:{removeWatchers(){window.removeEventListener("message",this.handleFrameMessages,!1),window.removeEventListener("popstate",this.handleHashChanges,!1),window.removeEventListener("hashchange",this.handleHashChanges,!1),document.removeEventListener("uip_breadcrumbs_change",this.handleBreadCrumbChange,{once:!1}),document.removeEventListener("uip_update_frame_url",this.handleURLchangeRequest,{once:!1})},mountMainWatchers(){document.addEventListener("uip_breadcrumbs_change",this.handleBreadCrumbChange,{once:!1}),document.addEventListener("uip_update_frame_url",this.handleURLchangeRequest,{once:!1}),this.iframeURLChange(this.$refs.contentframe,this.handleFrameURLChange)},mountProductionFunctions(){"prod"==this.uiTemplate.display&&(window.addEventListener("message",this.handleFrameMessages,!1),window.addEventListener("popstate",this.handleHashChanges,!1),window.addEventListener("hashchange",this.handleHashChanges,!1))},handleFrameURLChange(e){const t=this.$refs.contentframe;this.initiateLoading(),this.currentURL=e;const n=new URL(e);if(maybeForceReload(n),this.shouldReloadPage(n))return window.location.assign(n);this.handleIframeContentChanges(t,n,e)},initiateLoading(){document.dispatchEvent(new CustomEvent("uip_page_change_started")),this.loading=!0;setTimeout(()=>this.loading=!1,2e3)},shouldReloadPage(e){return"undefined"!=typeof UIPfrontEndReload&&UIPfrontEndReload&&"builder"!==this.uiTemplate.display&&!e.href.includes(this.returnAdminPage)},handleIframeContentChanges(e,t,n){const i=e.contentWindow.document.documentElement&&e.contentWindow.document.documentElement.getAttribute("uip-framed-page");if(t.searchParams.get("uip-framed-page")||i){const t=e.contentWindow.document.querySelectorAll("#adminmenu a[aria-current='page']");let i=n;return t[0]&&(i=t[0].getAttribute("href")),this.updateActiveLink(i),this.injectStyles(),void(this.loading=!1)}e.src="about:blank";const r=this.formatUserUrlOptions(t);e.contentWindow.location.replace(r)},async handleIframeLoad(e){const t=this.$refs.contentframe,n=t.contentWindow.location.href;if(!await this.checkPageLoaded())return window.location.assign(this.currentURL);this.mountFrameWatchers(),this.checkForUserFullSreen(n),this.loading=!1,this.rendered=!0;const i=t.contentDocument.title;i&&(document.title=i),"prod"==this.uiTemplate.display&&this.updateBrowserAddress(t.contentWindow.location.href),document.dispatchEvent(new CustomEvent("uip_page_change_loaded")),this.updatePageUrls()},async checkPageLoaded(){try{return this.$refs.contentframe.contentWindow.title,!0}catch(e){return!1}},handleURLchangeRequest(e){let t=e.detail.url;this.loading=!0;setTimeout(()=>this.loading=!1,2e3),t=this.formatUserUrlOptions(t),this.$refs.contentframe.contentWindow&&this.$refs.contentframe.contentWindow.location.assign(t)},handleBreadCrumbChange(e){this.breadCrumbs=e.detail.crumbs},handleFrameMessages(e){if(!e.data)return;const t="uip_request_fullscreen"===e.data.eventName,n="uip_exit_fullscreen"===e.data.eventName,i=this.$refs.frameContainer;t&&!this.isFullScreen()&&i.classList.add("uip-fullscreen-mode","uip-scale-in-bottom-right"),n&&this.isFullScreen()&&i.classList.remove("uip-fullscreen-mode","uip-scale-in-bottom-right")},handleHashChanges(e){window.location.href!=this.startPage&&this.$refs.contentframe.contentWindow.location.assign(window.location.href)},updateStartPage(){const{dynamicOptions:e}=this.uipApp.data,t=e.viewadmin.value;if(this.returnHomePage&&(this.startPage===t||this.startPage===`${t}#/`)){/^(?:[a-z+]+:)?\/\//i.test(this.returnHomePage)?this.startPage=this.returnHomePage:this.startPage=`${t}${this.returnHomePage}`}this.navigateFrameToStartPage()},getBlockOption(e,t,n){const i=this.get_block_option(this.block,"block",e,!0);return this.isObject(i)?t in i?i[t]:n:i||n},navigateFrameToStartPage(){let e=new URL(this.startPage);e=this.formatUserUrlOptions(e),this.$refs.contentframe.contentWindow.location.replace(e),this.updateActiveLink(this.startPage)},checkForUserFullSreen(e){if("undefined"!=typeof UIPFullscreenUserPages&&UIPFullscreenUserPages&&"builder"!=this.enviroment&&Array.isArray(UIPFullscreenUserPages))for(let t of UIPFullscreenUserPages)(e==t||e.includes(t))&&this.setFullScreen()},mountFrameWatchers(){const e=this.$refs.contentframe;if(e.contentWindow.document.addEventListener("click",e=>{"A"==e.target.tagName&&this.handleInsideFrameLink(e.target.href)}),"prod"!==this.uiTemplate.display)return;const t=function(e){e.addEventListener("submit",function(t){const n=new URL(e.action);n.searchParams.get("uip-framed-page")||(t.preventDefault(),this.formatUserUrlOptions(n),e.action=n.href,e.submit())})}.bind(this);["upgrade-plugins","upgrade-themes","upgrade"].forEach(n=>{const i=e.contentWindow.document.querySelector(`form[name="${n}"]`);i&&t(i)})},handleInsideFrameLink(e){if(!e)return;if(!/^(?:[a-z+]+:)?\/\//i.test(e))return;const t=this.extractDomain(this.uipApp.data.options.domain);e.includes(t)||(window.location.href=e)},extractDomain(e){const t=new URL(e),n=t.hostname.split(".");return n.length<=2?t.hostname:n.slice(-2).join(".")},updateBrowserAddress(e){const t=stripUIPparams(e);history.pushState({},null,t)},updatePageUrls(){const e=this.uipApp.data.options.adminURL;this.updateFormActions(e),this.updateFormHrefs(e)},updateFormActions(e){const t=this.$refs.contentframe.contentWindow.document.querySelectorAll("form");for(let n of t){let t=n.action;t&&"string"==typeof t&&(t.includes(e)&&(n.action=this.formatRequiredParams(t)))}},updateFormHrefs(e){const t=this.$refs.contentframe.contentWindow.document.querySelectorAll("body.update-php a");for(let n of t){let t=n.href;if(t&&"string"==typeof t)if(t.includes(e))n.href=this.formatRequiredParams(t);else{let i=e+t,r=this.formatRequiredParams(i);r=r.replace(e,""),n.href=r}}},formatUserUrlOptions(e){return e.searchParams.set("uip-framed-page",1),this.returnScreen&&e.searchParams.set("uip-hide-screen-options",1),this.returnHelp&&e.searchParams.set("uip-hide-help-tab",1),this.returnTheme&&e.searchParams.set("uip-default-theme",1),this.returnNotices&&e.searchParams.set("uip-hide-notices",1),e.searchParams.set("uipid",this.uiTemplate.id),e},formatRequiredParams(e){const t=new URL(e);return t.searchParams.set("uip-framed-page",1),this.returnScreen&&t.searchParams.set("uip-hide-screen-options",1),this.returnHelp&&t.searchParams.set("uip-hide-help-tab",1),this.returnTheme&&t.searchParams.set("uip-default-theme",1),this.returnNotices&&t.searchParams.set("uip-hide-notices",1),t.searchParams.set("uipid",this.uiTemplate.id),t.href},isFullScreen(){return this.$refs.frameContainer.classList.contains("uip-fullscreen-mode")},toggleFullScreen(){this.isFullScreen()?this.removeFullScreen():this.setFullScreen()},setFullScreen(){this.$refs.frameContainer.classList.add("uip-fullscreen-mode","uip-scale-in-bottom-right")},removeFullScreen(){this.$refs.frameContainer.classList.remove("uip-fullscreen-mode","uip-scale-in-bottom-right")},injectStyles(){const e=this.$refs.contentframe;if("prod"===this.uiTemplate.display)return;const t=this.uipApp.data.themeStyles,n=e.contentWindow.document.querySelector("#uip-theme-styles");if(!n)return;let i='html[data-theme="light"]{';for(const e in t){const n=t[e];n.value&&(i+=`${n.name}:${n.value};`)}i+="}";let r='html[data-theme="dark"]{';for(const e in t){const n=t[e];n.darkValue&&(r+=`${n.name}:${n.darkValue};`)}r+="}";const s=this.returnTemplateCSS;n.innerHTML=i+r+s},injectCSS(){const e=this.$refs.contentframe.contentWindow.document.getElementById("uip-theme-styles");if(!e)return;const t=this.returnTemplateCSS;e.innerText=t},iframeURLChange(e,t){let n=null;const i=()=>{if(!e.contentWindow)return;let i="";try{i=e.contentWindow.location.href}catch(t){return console.log("we caught the error"),void console.log(e.src)}i!==n&&(t(i),n=i)},r=()=>{setTimeout(i,0)},s=()=>{e.contentWindow.removeEventListener("unload",r),e.contentWindow.addEventListener("unload",r)};e.addEventListener("load",()=>{s(),i()}),s()}},template:'\n    \n    <div ref="frameContainer" class="uip-flex uip-flex-column uip-overflow-hidden uip-content-frame uip-overflow-hidden uip-position-relative" \n    :class="returnClasses" @mouseenter="scrollOver = true;">\n    \n      <div class="uip-position-relative" v-if="!hideLoader">\n        <div ref="loader" :class="block.uid" class="uip-ajax-loader" v-if="loading">\n        <div :class="block.uid" class="uip-loader-bar"></div>\n        </div>\n      </div>\n      \n      <iframe :style="returnLoadingStyle" :src="returnStartPage" ref="contentframe" \n      @load="handleIframeLoad"\n      class="uip-page-content-frame uip-background-default uip-scrollbar uip-w-100p uip-flex-grow" :class="{\'uip-no-select\' : uiTemplate.display != \'prod\' && !uiTemplate.isPreview}"></iframe>\n       \n      <div @mouseover="cornertickle = true" @mouseleave="cornertickle = false" class="uip-position-absolute uip-text-muted uip-top-0 uip-right-0 uip-cursor-pointer uip-flex uip-flex-column uip-flex-middle uip-padding-xs" v-if="!disableFullScreen">\n      \n        <div @click="toggleFullScreen()" v-if="cornertickle" class="uip-border-box uip-background-muted uip-text-muted uip-padding-xxxs uip-link-muted hover:uip-background-grey uip-flex uip-flex-column uip-flex-middle uip-fade-in uip-shadow-small uip-border-round" style="pointer-events: all">\n        <span v-if="isFullScreen()" class="uip-icon uip-text-l uip-slide-in-right uip-line-height-1">fullscreen_exit</span>\n        <span v-if="!isFullScreen()" class="uip-icon uip-text-l uip-line-height-1">fullscreen</span>\n        </div>\n        \n      </div>\n      \n      <template v-else>\n        \n        <component v-if="disableFullScreen" is="style">\n        .uip-fullscreen-toggle {\n         display:none; \n        }\n        .uip-fullscreen-mode .uip-fullscreen-toggle {\n         display:block; \n        }\n        </component>\n        \n        <div @mouseover="cornertickle = true" @mouseleave="cornertickle = false" class="uip-position-absolute uip-text-muted uip-top-0 uip-right-0 uip-cursor-pointer uip-flex uip-flex-column uip-flex-middle uip-padding-xs" v-if="!disableFullScreen">\n        \n        <div @click="toggleFullScreen()" v-if="cornertickle" class="uip-border-box uip-background-muted uip-text-muted uip-padding-xxxs uip-link-muted hover:uip-background-grey uip-flex uip-flex-column uip-flex-middle uip-fade-in uip-shadow-small uip-border-round" style="pointer-events: all">\n          <span v-if="isFullScreen()" class="uip-icon uip-text-l uip-slide-in-right uip-line-height-1">fullscreen_exit</span>\n          <span v-if="!isFullScreen()" class="uip-icon uip-text-l uip-line-height-1">fullscreen</span>\n        </div>\n        \n        </div>\n      \n      </template>\n      \n    </div>\n    '};