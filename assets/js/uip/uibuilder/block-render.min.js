import{nextTick,h,Teleport,ref}from"../../libs/vue-esm.js";import BlockStyles from"./block-styles.min.js";import BlockConditions from"./block-conditions.min.js";import BlockInteractions from"./block-interactions.min.js";const{__:__}=wp.i18n;export default{inject:["uiTemplate"],mixins:[BlockStyles,BlockConditions,BlockInteractions],props:{block:Object,list:Array,index:Number},data:()=>({query:{},strings:{proOptionUnlock:__("This is a pro option. Upgrade to unlock","uipress-lite"),search:__("Search","uipress-lite"),totalItems:__("total items","uipress-lite")},windowWidth:window.innerWidth}),beforeUnmount(){window.removeEventListener("resize",this.handleWindowResize)},mounted(){this.returnBlockParts,window.addEventListener("resize",this.handleWindowResize)},watch:{"block.query":{handler(){this.hasBlockQuery&&this.runBlockQuery()},immediate:!0,deep:!0},"query.currentPage":{handler(){this.hasBlockQuery&&this.runBlockQuery()}},"query.search":{handler(){this.hasBlockQuery&&this.runBlockQuery()}}},computed:{hasBlockQuery(){return this.hasNestedPath(this.block,["query","enabled"])},returnPostQueryCount(){return this.query.totalFound?this.query.totalFound:0},blockPaginationEnabled(){return this.hasNestedPath(this.block,["query","settings","showPagination"])},blockSearchEnabled(){return this.hasNestedPath(this.block,["query","settings","search"])},ifBlockHasLink(){return this.hasNestedPath(this.block,["linkTo","value"])},returnBlockStyles(){this.block.uid,this.uipApp.data.templateDarkMode,window.innerWidth;let t=this.formatDynamicMatches;return this.returnBlockStylesAsCss(t)+this.returnCustomCSS},returnCustomCSS(){let t=this.hasNestedPath(this.block,["settings","advanced","options","css","value"]);return t||(t=""),t},returnCustomJS(){let t=this.hasNestedPath(this.block,["settings","advanced","options","js","value"]);return t||(t=""),t},isProduction(){return"prod"==this.uiTemplate.display||!!this.uiTemplate.isPreview},formatDynamicMatches(){if(!this.isProduction)return this.block;let t=JSON.stringify(this.block);const e=t.matchAll(/{{(.*?)}}/g),i=Array.from(e);if(!Array.isArray(i))return this.block;for(let[e,s]of i.entries()){const e=s[0],i=s[1];i in this.uipApp.data.dynamicOptions&&(t=t.replace(e,this.uipApp.data.dynamicOptions[i].value))}return JSON.parse(t)},returnParams(){return{"block-uid":this.block.uid,block:this.formatDynamicMatches,class:this.returnBlockClasses(this.block),id:this.block.uid,title:this.returnToolTip(this.block)}},isHiddenForViewport(){const t=this.block.responsive;let e=this.windowWidth;const i=this.uiTemplate.windowWidth;return i&&(e=i),void 0!==t&&(!!t&&(!!(t.mobile&&e<699)||(!!(t.tablet&&e<990&&e>=699)||(!!(t.desktop&&e>990)||void 0))))},returnPostQuery(){let t=this.query.posts;return t||!1}},methods:{handleWindowResize(){this.windowWidth=window.innerWidth},async runBlockQuery(){const t=this.hasNestedPath(this.block,["query","settings"]);let e=JSON.stringify(t),i=JSON.stringify(this.block),s=this.query.currentPage;void 0===s&&(s=1);let r=this.query.search;void 0===r&&(r="");let o=new FormData;o.append("action","uip_process_block_query"),o.append("security",uip_ajax.security),o.append("query",e),o.append("blockString",i),o.append("page",s),o.append("search",r);const n=await this.sendServerRequest(uip_ajax.ajax_url,o);n.error&&this.uipApp.notifications.notify(n.message,"uipress-lite","","error",!0),n.success&&(this.query.posts=n.items.list,this.query.totalFound=n.items.found,this.query.dynamicMatches=n.items.matches,this.query.totalPages=n.items.totalPages,this.query.currentPage=s)},returnToolTip(t){let e=this.hasNestedPath(t,["tooltip","message"]);if(e)return e},returnBlockClasses(t,e){let i="";const s=this.get_block_option(t,"advanced","classes");return e&&(i+=` uip-query-id-${e}`),i+s},renderQuery(t){const e=this.returnPostQuery;let i=[];if(!Array.isArray(e))return i;for(let s of e){const e=this.formatQueryDynamicMatches(s.ID),r=this.returnQueryBlockStyles(e,s.ID),o=h(Teleport,{to:"body"},h("style",{scoped:""},r)),n={...this.returnQueryParams(e,s.ID),...this.returnWatchers(e)},a=h(t,n);i.push(o,a)}return i},returnQueryBlockStyles(t,e){this.block.uid,this.uipApp.data.templateDarkMode;let i=this.returnBlockStylesAsCss(t);return(i=i||"").replace("#"+t.uid,".uip-query-id-"+e+"#"+t.uid)},returnQueryParams(t,e){return{"block-uid":this.block.uid,block:t,class:this.returnBlockClasses(t,e),id:this.block.uid,title:this.returnToolTip(t)}},formatQueryDynamicMatches(t){const e=JSON.parse(JSON.stringify(this.formatDynamicMatches)),i=this.query.dynamicMatches;if(!(t in i))return e;let s=JSON.stringify(e);for(let e of i[t]){let t=e.replace;if("{{post_content}}"===e.match){t=JSON.stringify({html:`uip_remove_this${e.replace}uip_remove_this`}).split("uip_remove_this")[1]}const i=s.replace(e.match,t);try{JSON.parse(i),s=i}catch(t){console.error("Replacement resulted in invalid JSON:",t)}}try{return JSON.parse(s)}catch(t){return console.error("Error parsing final string:",t),this.dynamicMatches}},returnWatchers(t){let e={};return this.isProduction?e=this.handleBlockInteractions(t,e):(e.onclick=(t=>{t.stopPropagation(),t.preventDefault(),this.uipApp.blockControl.setActive(this.block,this.list,t)}),e.onmouseenter=(e=>{e.stopPropagation(),e.preventDefault(),this.uipApp.blockControl.setHover(e,t)}),e.onmouseleave=(e=>{e.stopPropagation(),e.preventDefault(),this.uipApp.blockControl.removeHover(e,t)}),e.oncontextmenu=(t=>{t.stopPropagation(),t.preventDefault(),this.uipApp.blockcontextmenu.show({event:t,list:this.list,index:this.index,block:this.block})}),e)},maybeFollowLink(t,e){const i=this.hasNestedPath(e,["linkTo","value"]),s=this.hasNestedPath(e,["linkTo","newTab"]);if(!i)return;if("dynamic"===s)return void this.updateAppPage(i);const r=this.$refs.blocklink;r.href=i;const o=t.ctrlKey||t.shiftKey||t.metaKey||t.button&&1===t.button||"newTab"===s;r.target=o?"_BLANK":"",r.click()},renderSearch(){if(!this.blockSearchEnabled)return[];const t=h("span",{class:"uip-icon uip-text-muted"},"search"),e={oninput:t=>this.query.search=t.target.value},i=h("input",{class:"uip-blank-input uip-flex-grow uip-text-s",type:"search",placeholder:this.strings.search,...e});return[h("div",{class:"uip-flex uip-search-block uip-border-round uip-query-search uip-w-100p uip-gap-xxs uip-flex-center"},t,i)]},renderPagination(){if(!this.blockPaginationEnabled)return[];const t=this.returnPostQueryCount+" "+this.strings.totalItems,e=h("div",{class:"uip-text-muted uip-pagination-count"},t);let i;if(this.query.totalPages>1){let t="uip-button-default uip-icon uip-pagination-button uip-border-rounder";this.query.currentPage<2&&(t+=" uip-link-disabled");const e=h("button",{class:t,...{onclick:()=>this.query.currentPage--},type:"button"},"chevron_left");let s="uip-button-default uip-icon uip-pagination-button uip-border-rounder";this.query.currentPage>=this.query.totalPages&&(s+=" uip-link-disabled");const r=h("button",{class:s,...{onclick:()=>this.query.currentPage++},type:"button"},"chevron_right");i=h("div",{class:"uip-flex uip-gap-xs uip-pagination-button-group"},e,r)}return[h("div",{class:"uip-flex uip-w-100p uip-flex-between uip-flex-center uip-pagination-controls"},e,i)]}},render(){let t=[];if(this.block.remote)return t;if(!this.blockMetConditions())return t;const e=this.returnBlockStyles,i=this.returnCustomJS,s=this.hasBlockQuery,r=this.ifBlockHasLink,o=this.isProduction;if(this.isHiddenForViewport)return t;e&&t.push(h(Teleport,{to:"body"},h("style",{scoped:""},e))),i&&t.push(h(Teleport,{to:"body"},h("script",{},i))),r&&t.push(h(Teleport,{to:"body"},h("a",{ref:"blocklink",class:"uip-hidden"})));const n=this.$root._.appContext.components[this.block.moduleName];if(!n){const e=h("div",{innerHTML:this.strings.proOptionUnlock,class:"uip-padding-xxs uip-border-rounder uip-background-green-wash uip-text-s uip-text-normal"});return t.push(e),t}const a=ref(null),u={...this.returnParams,...this.returnWatchers(this.block),...{ref:a}},l=h(n,u);if(s){const e=this.renderQuery(n),i=this.renderSearch(),s=this.renderPagination();let r=[l];o&&(r=[]),t=[...t,...i,...r,...e,...s]}else t.push(l);return this.isObject(this.uiTemplate.blockRefs)||(this.uiTemplate.blockRefs={}),this.uiTemplate.blockRefs[this.block.uid]={uid:this.block.uid,name:this.block.name,ref:a},t}};