import{nextTick,h,Teleport}from"../../libs/vue-esm-dev.js";import BlockStyles from"./block-styles.min.js";export default{inject:["uipress","uiTemplate"],mixins:[BlockStyles],props:{block:Object,list:Array,index:Number,contextualData:[Array,Object]},data:()=>({query:{},strings:{proOptionUnlock:__("This is a pro option. Upgrade to unlock","uipress-lite"),search:__("Search","uipress-lite"),totalItems:__("total items","uipress-lite")}}),mounted(){this.returnBlockParts},watch:{"block.query":{handler(){this.hasBlockQuery&&this.runBlockQuery()},immediate:!0,deep:!0},"query.currentPage":{handler(){this.hasBlockQuery&&this.runBlockQuery()}},"query.search":{handler(){this.hasBlockQuery&&this.runBlockQuery()}}},computed:{hasBlockQuery(){return this.uipress.checkNestedValue(this.block,["query","enabled"])},returnPostQueryCount(){return this.query.totalFound?this.query.totalFound:0},blockPaginationEnabled(){return this.uipress.checkNestedValue(this.block,["query","settings","showPagination"])},blockSearchEnabled(){return this.uipress.checkNestedValue(this.block,["query","settings","search"])},ifBlockHasLink(){return this.uipress.checkNestedValue(this.block,["linkTo","value"])},returnBlockStyles(){this.block.uid,this.uipApp.data.templateDarkMode,window.innerWidth;this.formatDynamicMatches;return this.returnBlockStylesAsCss(this.block)+this.returnCustomCSS},returnCustomCSS(){let t=this.uipress.checkNestedValue(this.block,["settings","advanced","options","css","value"]);return t||(t=""),t},returnCustomJS(){let t=this.uipress.checkNestedValue(this.block,["settings","advanced","options","js","value"]);return t||(t=""),t},isProduction(){return"prod"==this.uiTemplate.display||!!this.uiTemplate.isPreview},formatDynamicMatches(){if(!this.uiTemplate.isPreview)return this.block;let t=JSON.stringify(this.block);const e=t.matchAll(/{{(.*?)}}/g),s=Array.from(e);if(!Array.isArray(s))return this.block;for(let[e,i]of s.entries()){const e=i[0],s=i[1];s in this.uipApp.data.dynamicOptions&&(t=t.replace(e,this.uipApp.data.dynamicOptions[s].value))}return JSON.parse(t)},returnParams(){return{"block-uid":this.block.uid,block:this.formatDynamicMatches,class:this.returnBlockClasses(this.block),id:this.block.uid,title:this.returnToolTip(this.block),contextualData:this.contextualData}},isHiddenForViewport(){const t=this.block.responsive,e=this.uiTemplate.windowWidth;let s=window.innerWidth;return e&&(s=e),void 0!==t&&(!!t&&(!!(t.mobile&&s<699)||(!!(t.tablet&&s<990&&s>=699)||(!!(t.desktop&&s>990)||void 0))))},returnPostQuery(){let t=this.query.posts;return t||!1}},methods:{async runBlockQuery(){const t=this.uipress.checkNestedValue(this.block,["query","settings"]);let e=JSON.stringify(t),s=JSON.stringify(this.block),i=this.query.currentPage;void 0===i&&(i=1);let r=this.query.search;void 0===r&&(r="");let o=new FormData;o.append("action","uip_process_block_query"),o.append("security",uip_ajax.security),o.append("query",e),o.append("blockString",s),o.append("page",i),o.append("search",r);const n=await this.sendServerRequest(uip_ajax.ajax_url,o);n.error&&this.uipress.notify(n.message,"uipress-lite","","error",!0),n.success&&(this.query.posts=n.items.list,this.query.totalFound=n.items.found,this.query.dynamicMatches=n.items.matches,this.query.totalPages=n.items.totalPages,this.query.currentPage=i)},returnToolTip(t){let e=this.uipress.checkNestedValue(t,["tooltip","message"]);if(e)return e},returnBlockClasses(t,e){let s="";const i=this.get_block_option(t,"advanced","classes");return e&&(s+=` uip-query-id-${e}`),s+i},renderQuery(t){const e=this.returnPostQuery;let s=[];if(!Array.isArray(e))return s;for(let i of e){const e=this.formatQueryDynamicMatches(i.ID),r=this.returnQueryBlockStyles(e,i.ID),o=h(Teleport,{to:"body"},h("style",{scoped:""},r)),n={...this.returnQueryParams(e,i.ID),...this.returnWatchers(e)},u=h(t,n);s.push(o,u)}return s},returnQueryBlockStyles(t,e){this.block.uid,this.uipApp.data.templateDarkMode,window.innerWidth;return this.returnBlockStylesAsCss(t).replace("#"+t.uid,".uip-query-id-"+e+"#"+t.uid)},returnQueryParams(t,e){return{"block-uid":this.block.uid,block:t,class:this.returnBlockClasses(t,e),id:this.block.uid,title:this.returnToolTip(t),contextualData:this.contextualData}},formatQueryDynamicMatches(t){const e=JSON.parse(JSON.stringify(this.formatDynamicMatches)),s=this.query.dynamicMatches;if(!(t in s))return e;let i=JSON.stringify(e);for(let e of s[t]){let t=e.replace;if("{{post_content}}"===e.match){t=JSON.stringify({html:`uip_remove_this${e.replace}uip_remove_this`}).split("uip_remove_this")[1]}const s=i.replace(e.match,t);try{JSON.parse(s),i=s}catch(t){console.error("Replacement resulted in invalid JSON:",t)}}try{return JSON.parse(i)}catch(t){return console.error("Error parsing final string:",t),this.dynamicMatches}},returnWatchers(t){let e,s={},i=this.isProduction;return e=i?e=>{this.maybeFollowLink(e,t)}:t=>{t.stopPropagation(),t.preventDefault(),this.uipApp.blockControl.setActive(this.block,this.list,t)},s.onclick=e,i?s:(s.onmouseenter=(e=>{e.stopPropagation(),e.preventDefault(),this.uipApp.blockControl.setHover(e,t)}),s.onmouseleave=(e=>{e.stopPropagation(),e.preventDefault(),this.uipApp.blockControl.removeHover(e,t)}),s.oncontextmenu=(t=>{t.stopPropagation(),t.preventDefault(),this.uipApp.blockcontextmenu.show({event:t,list:this.list,index:this.index,block:this.block})}),s)},maybeFollowLink(t,e){const s=this.uipress.checkNestedValue(e,["linkTo","value"]),i=this.uipress.checkNestedValue(e,["linkTo","newTab"]);if(!s)return;if("dynamic"===i)return void this.updateAppPage(s);const r=this.$refs.blocklink;r.href=s;const o=t.ctrlKey||t.shiftKey||t.metaKey||t.button&&1===t.button||"newTab"===i;r.target=o?"_BLANK":"",r.click()},renderSearch(){if(!this.blockSearchEnabled)return[];const t=h("span",{class:"uip-icon uip-text-muted"},"search"),e={oninput:t=>this.query.search=t.target.value},s=h("input",{class:"uip-blank-input uip-flex-grow uip-text-s",type:"search",placeholder:this.strings.search,...e});return[h("div",{class:"uip-flex uip-search-block uip-border-round uip-query-search uip-w-100p uip-gap-xxs uip-flex-center"},t,s)]},renderPagination(){if(!this.blockPaginationEnabled)return[];const t=this.returnPostQueryCount+" "+this.strings.totalItems,e=h("div",{class:"uip-text-muted uip-pagination-count"},t);let s;if(this.query.totalPages>1){let t="uip-button-default uip-icon uip-pagination-button uip-border-rounder";this.query.currentPage<2&&(t+=" uip-link-disabled");const e=h("button",{class:t,...{onclick:()=>this.query.currentPage--},type:"button"},"chevron_left");let i="uip-button-default uip-icon uip-pagination-button uip-border-rounder";this.query.currentPage>=this.query.totalPages&&(i+=" uip-link-disabled");const r=h("button",{class:i,...{onclick:()=>this.query.currentPage++},type:"button"},"chevron_right");s=h("div",{class:"uip-flex uip-gap-xs uip-pagination-button-group"},e,r)}return[h("div",{class:"uip-flex uip-w-100p uip-flex-between uip-flex-center uip-pagination-controls"},e,s)]}},render(){let t=[];const e=this.returnBlockStyles,s=this.returnCustomJS,i=this.hasBlockQuery,r=this.ifBlockHasLink,o=this.isProduction;if(this.isHiddenForViewport)return t;e&&t.push(h(Teleport,{to:"body"},h("style",{scoped:""},e))),s&&t.push(h(Teleport,{to:"body"},h("script",{},s))),r&&t.push(h(Teleport,{to:"body"},h("a",{ref:"blocklink",class:"uip-hidden"})));const n=this.$root._.appContext.components[this.block.moduleName];if(!n){const e=h(div,{innerHTML:this.strings.proOptionUnlock,class:"uip-padding-xxs uip-border-rounder uip-background-green-wash uip-text-s"});return t.push(e),t}const u={...this.returnParams,...this.returnWatchers(this.block)},a=h(n,u);if(i){const e=this.renderQuery(n),s=this.renderSearch(),i=this.renderPagination();let r=[a];o&&(r=[]),t=[...t,...s,...r,...e,...i]}else t.push(a);return t}};