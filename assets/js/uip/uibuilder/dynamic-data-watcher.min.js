const{__:__,_x:_x,_n:_n,_nx:_nx}=wp.i18n;import{defineAsyncComponent,nextTick}from"../../libs/vue-esm.js";export default{components:{contextmenu:defineAsyncComponent(()=>import("../v3.5/utility/contextmenu.min.js?ver=3.3.1"))},data:function(){return{ui:{dynamicData:{display:!1,index:0,top:0,right:0,input:!1,search:"",inlineSearch:"",cursorPosition:0}},strings:{dynamicData:__("Dynamic data","uipress-lite"),searchData:__("Search","uipress-lite")},dynamicCategories:[{name:"query",label:__("Query","uipress-lite"),icon:"all_inclusive"},{name:"array",label:__("Array","uipress-lite"),icon:"data_array"},{name:"image",label:__("Image","uipress-lite"),icon:"image"},{name:"link",label:__("Link","uipress-lite"),icon:"link"},{name:"text",label:__("Text","uipress-lite"),icon:"title"}],dynamicOptions:[{name:"post_title",label:__("Post title","uipress-lite"),type:"query"},{name:"post_author",label:__("Post author","uipress-lite"),type:"query"},{name:"post_date",label:__("Post date","uipress-lite"),type:"query"},{name:"post_link",label:__("Post link","uipress-lite"),type:"query"},{name:"post_edit_link",label:__("Post edit link","uipress-lite"),type:"query"},{name:"post_featured_image",label:__("Post featured image","uipress-lite"),type:"query"},{name:"post_content",label:__("Post content","uipress-lite"),type:"query"},{name:"post_excerpt",label:__("Post excerpt","uipress-lite"),type:"query"},{name:"post_type",label:__("Post type","uipress-lite"),type:"query"},{name:"post_status",label:__("Post status","uipress-lite"),type:"query"},{name:"comment_count",label:__("Comment count","uipress-lite"),type:"query"},{name:"meta:key",label:__("Meta key","uipress-lite"),type:"query"},{name:"acf_meta:key",label:__("ACF Meta key","uipress-lite"),type:"query"},{name:"mb_meta:key",label:__("Metabox Meta key","uipress-lite"),type:"query"},{name:"attachment_image",label:__("Attachment image","uipress-lite"),type:"query"},{name:"post_mime_type",label:__("Attachment type","uipress-lite"),type:"query"},{name:"ID",label:__("User id","uipress-lite"),type:"query"},{name:"display_name",label:__("User display name","uipress-lite"),type:"query"},{name:"user_email",label:__("User email","uipress-lite"),type:"query"},{name:"user_login",label:__("User login","uipress-lite"),type:"query"},{name:"user_nicename",label:__("User nicename","uipress-lite"),type:"query"},{name:"user_registered",label:__("User registered","uipress-lite"),type:"query"},{name:"user_avatar",label:__("User profile image","uipress-lite"),type:"query"},{name:"meta:key",label:__("User meta","uipress-lite"),type:"query"},{name:"acf_user_meta:key",label:__("ACF User meta","uipress-lite"),type:"query"}],multisiteOptions:[{name:"registered",label:__("Site registered","uipress-lite"),type:"query"},{name:"domain",label:__("Site domain","uipress-lite"),type:"query"},{name:"last_updated",label:__("Site last updated","uipress-lite"),type:"query"},{name:"path",label:__("Site path","uipress-lite"),type:"query"},{name:"blog_id",label:__("Site id","uipress-lite"),type:"query"},{name:"site_name",label:__("Site name","uipress-lite"),type:"query"},{name:"site_home_url",label:__("Site home url","uipress-lite"),type:"query"},{name:"site_dashboard_url",label:__("Site admin url","uipress-lite"),type:"query"},{name:"meta:key",label:__("Site meta","uipress-lite"),type:"query"}]}},mounted(){this.formatDynamicData(),this.mountWatcher()},beforeUnmount(){this.ui.dynamicData.input&&(this.ui.dynamicData.input.removeEventListener("keydown",this.watchForClosure),this.ui.dynamicData.input.removeEventListener("keypress",this.watchKeyInput),this.ui.dynamicData.input.removeEventListener("click",this.watchKeyInput))},computed:{dynamicOptionsWithSearch(){return this.dynamicOptions.filter(e=>this.inSearch(e))}},methods:{formatDynamicData(){const e=Object.values(this.uipApp.data.dynamicOptions).sort((e,t)=>e.type<t.type?-1:e.type>t.type?1:0);this.uipApp.data.options.multisite&&(this.dynamicOptions=[...this.dynamicOptions,...this.multisiteOptions]),this.dynamicOptions=[...this.dynamicOptions,...e]},mountWatcher(){this.mountDynamicSequence("{{",(e,t)=>{window.innerWidth,e.x;this.ui.dynamicData.input=t,this.ui.dynamicData.search="",this.ui.dynamicData.cursorPosition=this.getCaretPosition(t);const i={clientX:e.x-220,clientY:e.y};this.$refs.dynamicdatamenu.show(i,i),this.ui.dynamicData.closeEvent=this.mountDynamicSequence("}}",this.closeDynamicData),t.addEventListener("keypress",this.watchKeyInput),t.addEventListener("keydown",this.watchForclosure)})},mountDynamicSequence(e,t){const i=i=>this.handleInputEvent(i,e,t);return document.addEventListener("input",i),i},handleInputEvent(e,t,i){if("INPUT"===e.target.tagName||e.target.classList.contains("ql-editor")){const a=this.returnInputValue(e.target),n=this.getCaretPosition(e.target),s=a.slice(n-t.length),r=s.slice(t.length);if(s.replace(r,"")===t){const t=e.target.getBoundingClientRect();i({x:t.left+n,y:t.top},e.target)}}},injectDynamicLabel(e){const t=this.ui.dynamicData.input;let i="{{";const a=`{{${e.name}}}`,n=this.ui.dynamicData.cursorPosition;this.ui.dynamicData.inlineSearch&&(i+=this.ui.dynamicData.inlineSearch);const s=this.returnInputValue(t),r=s.slice(0,n-i.length)+a+s.slice(n);"INPUT"===t.tagName?t.value=r:t.textContent=r,t.selectionStart=t.selectionEnd=n-i.length+a.length,t.dispatchEvent(new Event("input")),this.$refs.dynamicdatamenu.close(),this.closeDynamicData()},watchKeyInput(e){if(e.preventDefault(),"INPUT"===e.target.tagName||e.target.classList.contains("ql-editor")){switch(e.key){case"Backspace":this.ui.dynamicData.search=this.ui.dynamicData.search.slice(0,-1),this.ui.dynamicData.inlineSearch=this.ui.dynamicData.inlineSearch.slice(0,-1);break;case"Escape":this.closeDynamicData();break;case"Enter":this.dynamicOptionsWithSearch[this.ui.dynamicData.index]&&this.injectDynamicLabel(this.dynamicOptionsWithSearch[this.ui.dynamicData.index]);break;default:this.ui.dynamicData.search+=e.key,this.ui.dynamicData.inlineSearch+=e.key}this.ui.dynamicData.cursorPosition=this.getCaretPosition(e.target)}},watchForclosure(e){if("INPUT"!==e.target.tagName&&!e.target.classList.contains("ql-editor"))return;let t,i;switch(e.key){case"Escape":this.closeDynamicData();break;case"Enter":if(!this.dynamicOptionsWithSearch[this.ui.dynamicData.index])break;this.injectDynamicLabel(this.dynamicOptionsWithSearch[this.ui.dynamicData.index]);break;case"ArrowDown":t=this.dynamicOptionsWithSearch.length-1,this.ui.dynamicData.index=this.ui.dynamicData.index>=t?0:this.ui.dynamicData.index+1,i=this.dynamicOptionsWithSearch[this.ui.dynamicData.index].name,this.scrollItemIntoView(i);break;case"ArrowUp":t=this.dynamicOptionsWithSearch.length-1,this.ui.dynamicData.index=this.ui.dynamicData.index<=0?t:this.ui.dynamicData.index-1,i=this.dynamicOptionsWithSearch[this.ui.dynamicData.index].name,this.scrollItemIntoView(i)}},scrollItemIntoView(e){const t=`#${this.formatNameAsID(e)}`,i=document.querySelector(`#uip-dynamic-list ${t}`);i&&i.scrollIntoView({behavior:"auto",block:"nearest",inline:"center"})},closeDynamicData(){this.$refs.dynamicdatamenu.close(),this.ui.dynamicData.index=0,this.ui.dynamicData.search="",this.ui.dynamicData.inlineSearch="",document.removeEventListener("input",this.ui.dynamicData.closeEvent),this.ui.dynamicData.input.removeEventListener("keydown",this.watchForClosure),this.ui.dynamicData.input.removeEventListener("keypress",this.watchKeyInput),this.ui.dynamicData.input.removeEventListener("click",this.watchKeyInput)},returnInputValue:e=>e.classList.contains("ql-editor")?e.textContent:e.value,getCaretPosition(e){if("INPUT"===e.tagName)return e.selectionEnd;let t=0;if(!window.getSelection)return t;const i=window.getSelection();if(i.rangeCount>0){const a=i.getRangeAt(0),n=a.cloneRange();n.selectNodeContents(e),n.setEnd(a.endContainer,a.endOffset),t=n.toString().length}return t},inSearch(e){const t=e.label.toLowerCase(),i=e.name.toLowerCase(),a=e.type.toLowerCase(),n=this.ui.dynamicData.search.toLowerCase();return!!(t.includes(n)||i.includes(n)||a.includes(n))},formatNameAsID:e=>e.replace(":","-")},template:'\n      \n      <contextmenu ref="dynamicdatamenu">\n      \n          <div class="uip-padding-s uip-flex uip-flex-column uip-row-gap-s">\n              \x3c!-- Header --\x3e\n              <div class="uip-flex uip-flex-between uip-flex-center uip-min-w-200">\n                  <div class="uip-text-emphasis uip-text-bold uip-text-s">{{strings.dynamicData}}</div>\n                  <a class="uip-link-muted hover:uip-background-muted uip-icon uip-border-rounder uip-padding-xxxs uip-link-muted" \n                     @click="closeDynamicData()">close</a>\n              </div>\n      \n              \x3c!-- Search Box --\x3e\n              <div class="uip-flex uip-flex-column uip-row-gap-xs">\n                  <div class="uip-flex uip-search-block uip-padding-xxs uip-border-rounder uip-flex uip-gap-xxs uip-flex-center uip-background-muted">\n                      <span class="uip-icon uip-text-muted uip-icon uip-icon-medium">search</span>\n                      <input class="uip-blank-input uip-flex-grow uip-text-s" \n                             type="search" \n                             :placeholder="strings.searchData" \n                             autofocus \n                             v-model="ui.dynamicData.search">\n                  </div>\n              </div>  \n      \n              \x3c!-- Dynamic List --\x3e\n              <div class="uip-flex uip-flex-column uip-max-h-200 uip-row-gap-xxxs" id="uip-dynamic-list" style="overflow:auto;">\n                  <template v-for="cat in dynamicCategories">\n                      <template v-for="(data, index) in dynamicOptionsWithSearch">\n                          <div v-if="cat.name == data.type" \n                               class="uip-padding-xs uip-padding-top-xxs uip-padding-bottom-xxs hover:uip-background-muted uip-border-rounder uip-flex uip-flex-center uip-gap-xxxs" \n                               @click="injectDynamicLabel(data)" \n                               :class="{\'uip-background-muted uip-text-emphasis\' : index == ui.dynamicData.index}" \n                               :id="formatNameAsID(data.name)">\n      \n                              <span class="uip-text-muted uip-text-s">{{ cat.label }}</span>\n                              <span class="uip-icon uip-text-muted uip-text-s">chevron_right</span>\n                              <span class="uip-link-default">{{data.label}}</span>\n                          </div>\n                      </template>\n                  </template>\n              </div>\n          </div>\n          \n      </contextmenu>\n\n          '};