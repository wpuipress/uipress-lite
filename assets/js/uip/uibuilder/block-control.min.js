import{defineAsyncComponent,nextTick}from"../../libs/vue-esm.js";const{__:__,_x:_x,_n:_n,_nx:_nx}=wp.i18n;export default{components:{BlockSettings:defineAsyncComponent(()=>import("./block-settings.min.js?ver=3.3.1")),Confirm:defineAsyncComponent(()=>import("../v3.5/utility/confirm.min.js?ver=3.3.1"))},inject:["uiTemplate"],data:()=>({ai:!1,block:!1,list:!1,wrapVisible:!1,hoverWrapVisible:!1,hoverBlock:!1,aiLoading:!1,node:!1,hovernode:!1,strings:{loremIpsum:__("Gnerate lorem ipsum","uipress-lite"),aiFill:__("Create with AI","uipress-lite")},wrapPos:{top:null,left:null,width:null,height:null},hoverWrapPos:{top:null,left:null,width:null,height:null},resizer:{startX:0,startY:0,width:0,height:0,resizing:!1,wrap:!1,uid:!1,block:!1,blockWidth:0,blockHeight:0,previewBlockWidth:0,previewBlockHeight:0}}),watch:{"uipApp.scrolling":{handler(t,e){t||(this.setWrapPosition(),this.hoverBlock&&this.setHoverWrapPosition())},deep:!0},block:{async handler(t,e){this.block&&(await nextTick(),this.setWrapPosition())},deep:!0},"uiTemplate.content":{immediate:!0,async handler(){this.block&&(await nextTick(),this.setWrapPosition())},deep:!0}},created(){this.uipApp.blockControl=this},mounted(){document.addEventListener("keydown",this.watchBlockShortcuts)},beforeUnmount(){document.removeEventListener("keydown",this.watchBlockShortcuts)},computed:{isProduction(){return"prod"==this.uiTemplate.display||!!this.uiTemplate.isPreview},dontDisplayWraps(){const t=this.uipApp.scrolling,e=this.isProduction;return t||e},returnWrapStyle(){return this.wrapPos.border="1px solid #0080ffff",this.wrapPos},returnHoverWrapStyle(){return this.hoverWrapPos.border="1px solid #0080ffff",this.hoverWrapPos},returnHoveredBlockUID(){if(this.hoverBlock)return this.hoverBlock.uid}},methods:{watchBlockShortcuts(t){this.block&&this.wrapVisible&&this.list&&"INPUT"!==t.target.tagName&&"TEXTAREA"!==t.target.tagName&&("d"!==t.key.toLowerCase()||!t.metaKey||t.altKey||t.shiftKey||(t.preventDefault(),this.duplicateBlock()),8!==t.keyCode||!t.metaKey||t.altKey||t.shiftKey||(t.preventDefault(),this.deleteBlock()))},uniqueIds(t){if(!t)return[];if(!Array.isArray(t))return[];const e=this;return function t(i){for(let s of i)s.uid=e.createUID(),s.content&&s.content.length>0&&t(s.content)}(t),t},async syncBlockPattern(){if(!await this.$refs.confirm.show({title:__("Sync patern","uipress-lite"),message:__("This will update the pattern template and will sync this pattern's changes accross all templates using the same pattern?","uipress-lite"),okButton:__("Sync patern","uipress-lite")}))return;const t=this.uipApp.notifications.create({title:__("Syncing patterns","uipress-lite"),status:"success",message:"",dismissable:!1,loader:!0}),e=this.prepareJSON(this.block),i=this.$route.params.templateID;let s=new FormData;s.append("action","uip_sync_ui_pattern"),s.append("security",uip_ajax.security),s.append("pattern",e),s.append("patternID",this.block.patternID),s.append("templateID",i);const r=await this.sendServerRequest(uip_ajax.ajax_url,s);r.error?this.uipApp.notifications.notify(r.message,"uipress-lite","","error",!0):(r.success&&(r.newPattern&&(this.block.patternID=r.newPattern),r.newTemplate&&(this.uiTemplate.content=r.newTemplate),this.uiTemplate.patterns=r.patterns),this.uipApp.notifications.remove(t),this.uipApp.notifications.create({title:__("Patterns synced succesfully","uipress-lite"),status:"success",message:"",dismissable:!0,loader:!1}))},duplicateBlock(){const t=this.list.findIndex(t=>t.uid==this.block.uid);if(t<0)return;let e=JSON.parse(JSON.stringify(this.block));e.uid=this.createUID(),e.content&&e.content.length>0&&(e.content=this.uniqueIds(e.content)),this.list.splice(t,0,e)},deleteBlock(){const t=this.list.findIndex(t=>t.uid==this.block.uid);t<0||(this.list.splice(t,1),this.removeActive())},resetpositions(){this.setHoverWrapPosition(),this.setWrapPosition()},setActive(t,e,i,s){this.node=null,i&&i.currentTarget&&(this.node=i.currentTarget),this.block=t,this.list=e,this.$router.push({query:{...this.$route.query,block:this.block.uid}}),s||this.uipApp.blockSettings.show(this.block),this.setWrapPosition(),this.maybeCloseSiteSettings()},maybeCloseSiteSettings(){const t=this.$route.params.templateID;"templateSettings"==this.$route.name&&this.$router.push({path:`/uibuilder/${t}/`,query:{...this.$route.query}})},removeActive(){this.node=null,this.block=null,this.list=null,this.wrapVisible=!1,this.$router.push({query:{...this.$route.query,block:null}}),this.uipApp.blockSettings.close()},setHover(t,e){this.hoverBlock=e,this.hovernode=t.currentTarget,this.setHoverWrapPosition()},removeHover(t,e){this.hoverBlock=!1,this.hovernode=!1,this.hoverWrapVisible=!1},setHoverWrapPosition(){if(!this.hoverBlock)return this.hoverWrapVisible=!1;let t=this.hovernode?this.hovernode:document.querySelector(`[block-uid="${this.hoverBlock.uid}"]`);if(!t)return this.hoverWrapVisible=!1;let e=t.getBoundingClientRect();this.hoverWrapPos={top:e.top+"px",left:e.left+"px",width:e.width+"px",height:e.height+"px"},requestAnimationFrame(()=>{this.hoverWrapVisible=!0})},setWrapPosition(){if(!this.block)return this.wrapVisible=!1;if(!this.block.uid)return this.wrapVisible=!1;let t;if(!(t=this.node?this.node:document.querySelector(`[block-uid="${this.block.uid}"]`)))return this.wrapVisible=!1;let e=t.getBoundingClientRect();this.wrapPos={top:e.top+"px",left:e.left+"px",width:e.width+"px",height:e.height+"px"},requestAnimationFrame(()=>{this.wrapVisible=!0})}},template:'\n  \n  \t\t\x3c!-- Hover wrap --\x3e\n\t\t<div v-if="hoverWrapVisible && !dontDisplayWraps"\n\t\tclass="uip-border uip-position-fixed uip-fade-in uip-no-select"\n\t\t:style="returnHoverWrapStyle"></div>\n\t\t\n\t\t\n  \t  \t\x3c!-- Selected wrap --\x3e\n\t\t<div v-if="wrapVisible && !dontDisplayWraps"\n\t\tclass="uip-border uip-position-fixed uip-fade-in uip-no-select"\n\t\t:style="returnWrapStyle">\n\t\t\t\n\t\t  \n\t\t</div>\n\t\t\n        <KeepAlive>\n\t\t    <BlockSettings/>\n        </KeepAlive>\n        \n        <Confirm ref="confirm"/>\n\t\n\t\t'};