const{__:__,_x:_x,_n:_n,_nx:_nx}=wp.i18n;import{defineAsyncComponent,nextTick}from"../../libs/vue-esm.js";import BlockControl from"./block-control.min.js?ver=3.3.1";export default{components:{blockControl:BlockControl},inject:["uiTemplate"],data(){return{mounted:!1,loading:!0,firstRender:!1,templateID:this.$route.params.templateID,activeBlockID:!1,saving:!1,helpLoaded:!1,allUiTemplates:[],blockFrames:[],deviceSwitcherOpen:!1,domBlocks:[],scrollDebounce:null,scrollTimeout:!1,zoomTimeout:!1,ui:{zoom:.9,zoomoptions:!1,viewDevice:"desktop",strings:{backToList:__("Exit builder","uipress-lite"),toggleLayers:__("Toggle layers panel","uipress-lite"),backToList:__("Back to template list","uipress-lite"),zoomIn:__("Zoom in","uipress-lite"),zoomOut:__("Zoom out","uipress-lite"),darkMode:__("Dark mode","uipress-lite"),preview:__("Preview","uipress-lite"),import:__("Import template","uipress-lite"),export:__("Export template","uipress-lite"),templateLibrary:__("Template Library","uipress-lite"),mobile:__("Mobile","uipress-lite"),desktop:__("Desktop","uipress-lite"),tablet:__("Tablet","uipress-lite"),saveTemplate:__("Save","uipress-lite"),help:__("Help","uipress-lite"),active:__("Active","uipress-lite"),draft:__("Draft","uipress-lite"),active:__("Active","uipress-lite"),draft:__("Draft","uipress-lite"),recenter:__("Re-center","uipress-lite"),showGridLines:__("Show grid lines","uipress-lite"),frame:__("frame","uipress-lite"),zoom100:__("Zoom to fit","uipress-lite")}},previewOptions:[{value:"builder",label:__("Builder","uipress-lite")},{value:"preview",label:__("Preview","uipress-lite")}]}},watch:{"uiTemplate.globalSettings.type":{async handler(e,i){await nextTick(),await this.setCanvasPosition()},deep:!0},"ui.viewDevice":{handler(e,i){this.handleViewPortChange()},deep:!0},"uipApp.data.templateDarkMode":{handler(e,i){let t=e?"dark":"light",n=document.getElementsByClassName("uip-page-content-frame");n[0]&&n[0].contentWindow.document.documentElement.setAttribute("data-theme",t)},deep:!0},"uipApp.data.userPrefs.darkTheme":{handler(e,i){"prod"!=this.uiTemplate.display&&(this.uipApp.data.templateDarkMode=e)},deep:!0},"ui.zoom":{async handler(e,i){if(!this.mounted)return;this.ui.zoom;this.$refs.framewrap.style.transform=`scale(${this.ui.zoom})`,clearTimeout(this.zoomTimeout),this.zoomTimeout=setTimeout(()=>{let e=Math.round(10*this.ui.zoom)/10;this.saveUserPreference("builderPrefersZoom",String(e),!1)},300)}},"$route.params.templateID":{handler(){this.templateID=this.$route.params.templateID}},"$route.params.uid":{handler(){this.activeBlockID=this.$route.params.uid}}},created(){this.setTheme()},beforeUnmount(){this.$refs.previewCanvas.removeEventListener("wheel",this.scrollCanvas),window.addEventListener("keydown",this.watchShortCuts)},async mounted(){this.initiateCanvas(),this.mountWatchers(),await this.$nextTick(),this.mounted=!0},computed:{returnHumanZoom(){return parseInt(100*this.ui.zoom)+"%"},returnActiveBlockUID(){return this.activeBlockID},returnAllUiTemplates(){let e=this;if(!(e.allUiTemplates.length<1))return this.allUiTemplates;{let i=new FormData;i.append("action","uip_get_ui_templates"),i.append("security",uip_ajax.security),i.append("page",1),i.append("search",""),e.sendServerRequest(uip_ajax.ajax_url,i).then(e=>(this.allUiTemplates=e.templates,this.allUiTemplates))}},returnTemplateJS(){if(void 0!==this.uiTemplate.globalSettings.options)return"advanced"in this.uiTemplate.globalSettings.options&&"js"in this.uiTemplate.globalSettings.options.advanced?this.uiTemplate.globalSettings.options.advanced.js:void 0},returnTemplateCSS(){if(void 0!==this.uiTemplate.globalSettings.options)return"advanced"in this.uiTemplate.globalSettings.options&&"css"in this.uiTemplate.globalSettings.options.advanced?this.uiTemplate.globalSettings.options.advanced.css:void 0},getBlockFrames(){return this.blockFrames=[],this.findBlocksByComponentName(this.uiTemplate.content,["uip-dropdown","uip-block-modal","uip-slide-out","uip-accordion"],this.blockFrames),this.blockFrames},returnScale(){let e=parseFloat(this.ui.zoom),i=100*e;return`scale:${1/e};transform-origin:${this.uipApp.isRTL?"bottom right":"bottom left"};width:${i}%`},returnColorMode(){return this.uipApp.data.userPrefs.darkTheme?"dark":this.uipApp.data.templateDarkMode?"dark":"light"},returnThemeIcon(){return this.uipApp.data.userPrefs.darkTheme?"light_mode":"dark_mode"}},methods:{async initiateCanvas(){"Mac"==this.detectOperatingSystem()&&document.body.classList.add("macos");let e=parseFloat(this.uipApp.data.userPrefs.builderPrefersZoom);void 0===e||isNaN(e)||(this.ui.zoom=e),this.$refs.framewrap.style.transform=`scale(${this.ui.zoom})`,await nextTick(),this.firstRender=!0,this.activeBlockID=this.$route.params.uid,await nextTick(),await this.setCanvasPosition(),this.loading=!1},mountWatchers(){this.$refs.previewCanvas.addEventListener("wheel",this.scrollCanvas),window.addEventListener("keydown",this.watchShortCuts)},watchShortCuts(e){"-"===e.key&&(e.metaKey||e.ctrlKey)&&(e.preventDefault(),this.zoom(-.1)),"+"!==e.key&&"Equal"!=e.code||!e.metaKey&&!e.ctrlKey||(e.preventDefault(),this.zoom(.1)),"0"===e.key&&(e.metaKey||e.ctrlKey)&&(e.preventDefault(),this.fitCanvas(),this.uipApp.data.userPrefs.builderPrefersZoom=1)},async zoom(e){e<0&&this.ui.zoom<.05||(this.uipApp.scrolling=!0,this.ui.zoom+=e,this.uipApp.data.userPrefs.builderPrefersZoom=this.ui.zoom,await nextTick(),this.uipApp.scrolling=!1)},findBlocksByComponentName(e,i,t){if(e&&Array.isArray(e))for(const n of e)n&&n.moduleName&&i.includes(n.moduleName)?t.push(n):n&&n.content&&this.findBlocksByComponentName(n.content,i,t)},async fitCanvas(){this.uipApp.scrolling=!0;const e=this.$refs.previewCanvas,i=this.$refs.templatebody.offsetWidth,t=e.offsetWidth/i;this.ui.zoom=t,await nextTick(),this.uipApp.scrolling=!1},scrollCanvas(e){if(e.preventDefault(),this.uipApp.scrolling=!0,clearTimeout(this.scrollTimeout),this.scrollTimeout=setTimeout(()=>{this.uipApp.scrolling=!1},150),e.ctrlKey)return e.deltaY<0&&this.zoom(.02),void(e.deltaY>=0&&this.zoom(-.02));let i=this.$refs.framewrap,t=parseFloat(i.style.top||0),n=parseFloat(i.style.left||0);"Mac"==this.detectOperatingSystem()?(t-=e.deltaY,n-=e.deltaX):(t+=e.deltaY,n+=e.deltaX),i.style.top=`${t}px`,i.style.left=`${n}px`},async setCanvasPosition(){const e=this.$refs.previewCanvas.offsetWidth,i=this.$refs.previewCanvas.offsetHeight,t=(e-this.$refs.templatebody.offsetWidth)/2,n=(i-this.$refs.templatebody.offsetHeight)/2;return this.$refs.framewrap.style.top=`${n}px`,this.$refs.framewrap.style.left=`${t}px`,await this.$nextTick(),!0},handleViewPortChange(){const e=this.ui.viewDevice;if("desktop"==e){this.uiTemplate.windowWidth="1000";let e=document.getElementById("uip-preview-content");e&&(e.classList.add("uip-desktop-view"),e.classList.remove("uip-tablet-view"),e.classList.remove("uip-phone-view"))}if("tablet"==e){this.uiTemplate.windowWidth="699";let e=document.getElementById("uip-preview-content");e&&(e.classList.add("uip-tablet-view"),e.classList.remove("uip-desktop-view"),e.classList.remove("uip-phone-view"))}if("phone"==e){this.uiTemplate.windowWidth="600";let e=document.getElementById("uip-preview-content");e&&(e.classList.add("uip-phone-view"),e.classList.remove("uip-tablet-view"),e.classList.remove("uip-desktop-view"))}let i=new CustomEvent("uipress/builder/preview/change",{detail:{windowWidth:this.uiTemplate.windowWidth}});document.dispatchEvent(i),requestAnimationFrame(()=>{this.setCanvasPosition()})},detectOperatingSystem(){const e=window.navigator.userAgent.toLowerCase();return e.includes("mac")||e.includes("ipad")||e.includes("iphone")?"Mac":"Windows"},handleCanvasDrag(e){let i={top:0,left:0,x:0,y:0},t=this.$refs.framewrap,n=this.$refs.previewCanvas;if(2===e.button)return;if(t.contains(e.target))return;e.preventDefault(),n.style.cursor="grabbing",n.style.userSelect="none";let s=parseFloat(t.style.top||0),a=parseFloat(t.style.left||0);i={left:a,top:s,x:e.clientX,y:e.clientY};const p=e=>{const n=e.clientX-i.x,s=e.clientY-i.y;t.style.top=`${i.top+s}px`,t.style.left=`${i.left+n}px`},l=e=>{n.style.cursor="default",n.style.removeProperty("user-select"),document.removeEventListener("mousemove",p),document.removeEventListener("mouseup",l)};document.addEventListener("mousemove",p),document.addEventListener("mouseup",l)},toggleDisplay(){"preview"==this.uiTemplate.display?this.uiTemplate.display="builder":this.uiTemplate.display="preview"},toggleDarkMode(){this.uipApp.data.userPrefs.darkTheme=!this.uipApp.data.userPrefs.darkTheme,this.setTheme(),this.saveUserPreference("darkTheme",this.uipApp.data.userPrefs.darkTheme,!1)},setTheme(){let e="light";this.uipApp.data.userPrefs.darkTheme?(e="dark",this.uipApp.data.userPrefs.darkTheme=!0):this.uipApp.data.userPrefs.darkTheme=!1,document.getElementsByTagName("html")[0].setAttribute("data-theme",e);let i=document.getElementsByClassName("uip-page-content-frame");if(i[0])for(const t of i)t.contentWindow.document.documentElement.setAttribute("data-theme",e)},formatStyles(){let e=this.uipApp.data.themeStyles,i={};for(let t in e)e[t].value&&(i[e[t].name]||(i[e[t].name]={}),i[e[t].name].value=e[t].value),e[t].darkValue&&(i[e[t].name]||(i[e[t].name]={}),i[e[t].name].darkValue=e[t].darkValue),e[t].user&&(i[e[t].name].user=e[t].user,i[e[t].name].label=e[t].label,i[e[t].name].name=e[t].name,i[e[t].name].type=e[t].type);return i}},template:'\n    \n    \n      <component is="style" scoped >\n        .user-style-area{\n          <template v-for="item in uipApp.data.themeStyles">\n             <template v-if="item.value">{{item.name}}:{{item.value}};</template>\n          </template>\n        }\n        [data-theme="dark"] .user-style-area, .uip-dark-mode .user-style-area, .uip-dark-mode.user-style-area, .user-style-area .uip-dark-mode {\n          <template v-for="item in uipApp.data.themeStyles">\n             <template v-if="item.darkValue"> {{item.name}}:{{item.darkValue}};</template>\n          </template>\n        }\n        {{returnTemplateCSS}}\n      </component>\n      <component is="script" scoped >\n        {{returnTemplateJS}}\n      </component>\n\n      \n      \n      <div ref="previewcontainer" class="uip-h-100p uip-w-100p uip-flex uip-flex-column uip-max-h-100p uip-overflow-hidden">\n        \n        \x3c!--preview area --\x3e\n        \n        <div id="uip-preview-canvas" ref="previewCanvas" class="uip-flex-grow uip-flex-grow uip-flex-middle uip-overflow-hidden uip-max-w-100p uip-max-h-100p uip-w-100p uip-border-box"\n        :data-theme="returnColorMode" @click="uipApp.blockControl.removeActive()" @mousedown="handleCanvasDrag($event)">\n        \n              \n              <div ref="framewrap" class="uip-flex uip-gap-l uip-flex-start uip-w-auto uip-position-absolute" id="uip-frame-wrap">\n                \n                \x3c!--Primary template --\x3e\n                <div class="uip-flex uip-flex-column">\n                \n                  \n                  <div class="uip-background-muted uip-border uip-flex uip-gap-xs uip-flex-center uip-padding-xxs uip-padding-left-xs uip-margin-bottom-s" :style="returnScale"\n                  style="border-radius: calc( var(--uip-border-radius) + var(--uip-padding-xxs) );"\n                  :class="uiTemplate.isPreview ? \'uip-opacity-0\' : \'\'">\n                  \n                  \n                      <div class="uip-text-muted uip-flex-grow uip-text-s" >{{uiTemplate.globalSettings.name}}</div>\n                      \n                      \x3c!--Device switcher--\x3e\n                      \n                      <dropdown pos="bottom right">\n                      \n                        <template v-slot:trigger>\n                    \n                          <div class="uip-padding-left-xs uip-padding-right-xs uip-border-rounder uip-flex uip-gap-xs uip-flex-between uip-link-muted uip-flex-center uip-text-s" style=""  \n                          @click="deviceSwitcherOpen = !deviceSwitcherOpen">\n                              <div class="">\n                                <template v-if="ui.viewDevice == \'desktop\'">{{ui.strings.desktop}}</template>\n                                <template v-if="ui.viewDevice == \'tablet\'">{{ui.strings.tablet}}</template>\n                                <template v-if="ui.viewDevice == \'phone\'">{{ui.strings.mobile}}</template>\n                              </div>\n                              <div class="uip-icon uip-text-l">expand_more</div>\n                          </div>\n                      \n                        </template>\n                        \n                        <template v-slot:content>\n                        \n                          <div class="uip-padding-xs">\n                            <div class="uip-flex uip-flex-row uip-flex-center uip-gap-xs uip-padding-xxs hover:uip-background-muted uip-border-rounder uip-gap-l uip-flex-between uip-link-default" \n                            @click="ui.viewDevice = \'desktop\';deviceSwitcherOpen = false;">\n                              \n                              <div class="">{{ui.strings.desktop}}</div>\n                              <div class="uip-flex uip-flex-center uip-text-muted uip-gap-xxxs">\n                                <span class="uip-icon" style="line-height:0">desktop_windows</span>\n                              </div>\n                              \n                            </div> \n                            \n                            <div class="uip-flex uip-flex-row uip-flex-center uip-gap-xs uip-padding-xxs hover:uip-background-muted uip-border-rounder uip-gap-l uip-flex-between uip-link-default" \n                            @click="ui.viewDevice = \'tablet\';deviceSwitcherOpen = false;">\n                              \n                              <div class="">{{ui.strings.tablet}}</div>\n                              <div class="uip-flex uip-flex-center uip-text-muted uip-gap-xxxs">\n                                <span class="uip-icon">tablet_mac</span>\n                              </div>\n                              \n                            </div> \n                            \n                            \n                            <div class="uip-flex uip-flex-row uip-flex-center uip-gap-xs uip-padding-xxs hover:uip-background-muted uip-border-rounder uip-gap-l uip-flex-between uip-link-default" \n                            @click="ui.viewDevice = \'phone\';deviceSwitcherOpen = false">\n                              \n                              <div class="">{{ui.strings.mobile}}</div>\n                              <div class="uip-flex uip-flex-center uip-text-muted uip-gap-xxxs">\n                                <span class="uip-icon">smartphone</span>\n                              </div>\n                              \n                            </div> \n                          </div>\n                        \n                        </template>\n                        \n                      </dropdown>\n                        \n                    \n                  </div>\n                \n                  <div class="uip-position-relative" :class="uiTemplate.globalSettings.type" style="transform: translate(0, 0)">\n                    <div id="uip-preview-content" class="uip-flex uip-flex-column uip-text-normal uip-desktop-view uip-position-relative uip-block-canvas">\n                      \n                      \x3c!--PAGE BODY--\x3e\n                      <div ref="templatebody" id="uip-template-body" class="uip-flex uip-flex-grow uip-text-normal uip-body-font uip-background-default uip-border-round uip-border" >\n                    \n                          \x3c!--MAIN DROP AREA--\x3e\n                          <uip-content-area :content="uiTemplate.content" :returnData="function(data) {uiTemplate.content = data}" class="user-style-area"></uip-content-area>\n                          \x3c!--END OF MAIN DROP AREA--\x3e\n                        \n                      </div>\n                    </div>\n                  </div>\n                  \n                \n                </div>\n                \x3c!--End primary template--\x3e\n                \n                \x3c!--Output frames--\x3e\n                \n                <template v-for="block in getBlockFrames">\n                \n                  <div class="uip-flex uip-flex-column" :id="\'block-frame-wrap-\' + block.uid" :class="uiTemplate.isPreview ? \'uip-opacity-0\' : \'\'">\n                  \n                  \n                    <div class="uip-background-muted uip-border uip-flex uip-gap-xs uip-flex-center uip-padding-xxs uip-margin-bottom-s" :style="returnScale"\n                    style="border-radius: calc( var(--uip-border-radius) + var(--uip-padding-xxs) );"\n                    :id="\'block-frame-title-\' + block.uid"\n                    :class="uiTemplate.isPreview ? \'uip-opacity-0\' : \'\'">\n                    \n                      <div :title="ui.strings.preview" class="uip-icon uip-border-rounder" style="">crop_free</div>\n                      <div class="uip-text-muted uip-text-s uip-flex-grow uip-no-wrap uip-overflow-hidden uip-text-ellipsis">{{block.name}} {{ui.strings.frame}}</div>\n                      \n                    </div>\n                    \n                    \n                    \x3c!--Frame content--\x3e\n                    <div class="uip-position-relative uip-frame-content">\n                    \n                      <div class="uip-text-normal uip-body-font uip-background-default uip-border-round uip-border uip-min-h-300 uip-min-w-200 uip-overflow-visible uip-block-canvas uip-flex uip-flex-column" \n                      :id="\'block-frame-\' + block.uid">\n                      \n                        \n                          \x3c!--BLOCK MAIN DROP AREA--\x3e\n                          <uip-content-area :content="block.content" :returnData="function(data) {block.content = data}" class="user-style-area uip-w-100p uip-flex-grow"/>\n                          \x3c!--END OF MAIN DROP AREA--\x3e\n                        \n                      </div>\n                    \n                    </div>\n                    \n                    \n                  </div>  \n                \n                </template>\n                \n                \x3c!--Endframes--\x3e\n              \n              </div>\n              \n          \n          \n        </div>\n        \x3c!--end of preview area --\x3e\n        \n        \n        <div class="uip-position-fixed uip-bottom-0 uip-left-50p uip-translateX--50p uip-z-index-1" style="bottom:32px">\n          \n          \n          \n            <div class="uip-flex uip-flex-center uip-padding-xs uip-background-default uip-shadow uip-border" style="border-radius: calc( var(--uip-border-radius-large) + var(--uip-padding-xs) )">\n               \n                \n                \n                \n                <dropdown pos="top left">\n                  \n                  <template v-slot:trigger>\n                \n                    <div class="uip-background-muted uip-padding-xxs uip-border-rounder uip-flex uip-gap-s uip-flex-between uip-link-default uip-flex-center">\n                        <div class="">{{returnHumanZoom}}</div>\n                        <div class="uip-icon uip-text-l">expand_less</div>\n                    </div>\n                  \n                  </template>\n                  \n                  <template v-slot:content>\n                    <div class="uip-padding-xs uip-flex uip-flex-column uip-text-s">\n                      \n                      <div class="uip-flex uip-flex-row uip-flex-center uip-gap-xs uip-padding-xxs hover:uip-background-muted uip-border-rounder uip-gap-l uip-flex-between uip-link-default" @click="zoom(-0.1)">\n                        \n                        <div class="uip-no-wrap">{{ui.strings.zoomOut}}</div>\n                        <div class="uip-flex uip-flex-center uip-text-muted uip-gap-xxxs">\n                          \n                          <span class="uip-command-icon"></span>\n                          <span class="uip-icon" style="line-height:0">remove</span>\n                          \n                        </div>\n                        \n                      </div> \n                      \n                      <div class="uip-flex uip-flex-row uip-flex-center uip-gap-xs uip-padding-xxs hover:uip-background-muted uip-border-rounder uip-gap-l uip-flex-between uip-link-default" @click="zoom(0.1)">\n                        \n                        <div class="uip-no-wrap">{{ui.strings.zoomIn}}</div>\n                        <div class="uip-flex uip-flex-center uip-text-muted uip-gap-xxxs">\n                        \n                          <span class="uip-command-icon"></span>\n                          <span class="uip-icon" style="line-height:0">add</span>\n                          \n                        </div>\n                        \n                      </div> \n                      \n                      \n                      <div class="uip-flex uip-flex-row uip-flex-center uip-gap-xs uip-padding-xxs hover:uip-background-muted uip-border-rounder uip-gap-l uip-flex-between uip-link-default" @click="fitCanvas()">\n                        \n                        <div class="uip-no-wrap">{{ui.strings.zoom100}}</div>\n                        <div class="uip-flex uip-flex-center uip-text-muted uip-gap-xxxs">\n                        \n                          <span class="uip-command-icon"></span>\n                          <span class="uip-icon" style="line-height:0">exposure_zero</span>\n                          \n                        </div>\n                        \n                      </div> \n                      \n                      \n                      \n                    </div>\n                  </template>\n                \n                </dropdown>\n                \n                <div class=" uip-margin-left-xs uip-margin-right-xs uip-h-20"></div>\n                \n                \n                \n                \n               \n                \n                <div :title="ui.strings.recenter" class="hover:uip-background-muted uip-padding-xxxs uip-border-round uip-flex uip-flex-center  uip-icon uip-link-default uip-text-xl uip-ratio-1-1 uip-line-height-1 uip-icon-medium" @click="setCanvasPosition()">\n                center_focus_strong\n                </div>\n                \n                <div :title="ui.strings.showGridLines" class="hover:uip-background-muted uip-padding-xxxs uip-border-round uip-flex uip-flex-center  uip-icon uip-link-default uip-text-xl uip-ratio-1-1 uip-line-height-1 uip-icon-medium" @click="toggleDisplay()" :class="{\'uip-background-grey uip-text-emphasis\' : uiTemplate.display != \'preview\'}">\n                grid_3x3\n                </div>\n                \n                \x3c!-- Dark mode --\x3e\n                <div :title="ui.strings.darkMode" class="hover:uip-background-muted uip-padding-xxxs uip-border-round uip-flex uip-flex-center  uip-icon uip-link-default uip-text-xl uip-ratio-1-1 uip-line-height-1 uip-icon-medium" @click="toggleDarkMode()">\n                {{returnThemeIcon}}\n                </div>\n                \n                \n                  \n                \n                \n                \n              \n            </div>\n          \n        </div>\n        \n        \n        \n        \x3c!-- End right click --\x3e\n      </div>\n      \n      \n      \n      \n      <blockControl/>\n      \n      '};