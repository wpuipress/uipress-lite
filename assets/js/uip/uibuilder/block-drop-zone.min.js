import{nextTick}from"../../libs/vue-esm.js";import blockRender from"./block-render.min.js?ver=3.3.1";const{__:__}=wp.i18n;export default{components:{BlockRender:blockRender},props:{content:{default:[],type:Array},returnData:Function,layout:String,dropAreaStyle:String},data(){return{items:[],rendered:!0,randomClass:this.createUID()}},inject:["uiTemplate"],watch:{content:{async handler(e,t){this.items=this.content,this.$refs.dropzone&&(this.$refs.dropzone.computeIndexes(),await nextTick(),this.maybeImportRemote())},immediate:!0,deep:!0}},computed:{strings:()=>({doesntExist:__("This component is missing or can't be loaded","uipress-lite"),totalItems:__("Total items","uipress-lite"),search:__("Search","uipress-lite"),proOptionUnlock:__("This is a pro option. Upgrade to unlock","uipress-lite")}),isProduction(){return"prod"==this.uiTemplate.display||!!this.uiTemplate.isPreview},itemsLength(){return this.items.length},async returnItems(){return this.items},returnDragGroupOptions:()=>({name:"uip-blocks",pull:!0,put:!0,revertClone:!1})},methods:{async forceReload(){this.rendered=!1,await nextTick(),this.rendered=!0},maybeImportRemote(){for(let e=this.items.length-1;e>=0;e--){const t=this.items[e];t.remote&&(this.items.splice(e,1),this.importBlock(t,e))}},async importBlock(e,t){let i=new FormData,n=this.uipApp.notifications.notify(__("Importing template","uipress-lite"),"","default",!1,!0);const s=await this.sendServerRequest(e.path,i);s.error&&(this.uipApp.notifications.notify(s.message,"","error",!0),this.uipApp.notifications.remove(n));let r=JSON.parse(s);if(Array.isArray(r)){(r=r[0]).uid=this.createUID(),this.isObject(r)||(this.uipApp.notifications.notify(__("Unable to import template right now","uipress-lite"),"","error",!0),this.uipApp.notifications.remove(n));let e=[];if("content"in r){for(const t of r.content)e.push(this.cleanBlock(t));r.content=e}this.uipApp.notifications.remove(n),this.uipApp.notifications.notify(__("Template imported","uipress-lite"),"","success",!0),this.items.splice(t,0,r)}else this.uipApp.notifications.notify(__("Unable to import template right now","uipress-lite"),"","error",!0),this.uipApp.notifications.remove(n)},cleanBlock(e){let t=Object.assign({},e);return t.options=[],t.settings=JSON.parse(JSON.stringify(t.settings)),t.content&&(t.content=this.duplicateChildren(t.content)),t},duplicateChildren(e){let t=[];for(let i of e){let e=Object.assign({},i);e.settings=JSON.parse(JSON.stringify(e.settings)),e.content&&(e.content=this.duplicateChildren(e.content)),t.push(e)}return t},async itemAdded(e){if(e.removed)return await this.forceReload(),void this.returnData(this.items);if(!e.added)return;let t=e.added.element;if(t.remote)return this.items.splice(e.added.newIndex,1),void this.importBlock(t,e.added.newIndex);"uid"in t||(t.uid=this.createUID()),await this.forceReload(),this.uipApp.blockControl.setActive(t,this.items),this.returnData(this.items)}},template:'\n    \n      \n      \n                 \n      <uip-draggable v-if="rendered && !isProduction"\n      ref="dropzone"\n      :class="[{\'uip-border-dashed\' : uiTemplate.display == \'builder\'}, randomClass]" \n      class="uip-flex uip-w-100p"\n      :group="returnDragGroupOptions" \n      :list="content"\n      @start="uipApp.scrolling=true"\n      @end="uipApp.scrolling=false"\n      ghostClass="uip-canvas-ghost"\n      @change="itemAdded"\n      animation="300"\n      :sort="true">\n              \n              <template v-for="(element, index) in items" \n              :key="index" :index="index">\n                \n                <BlockRender :block="element" :list="items" :index="index"/>\n              \n              </template>\n              \n              \n      </uip-draggable>\n      \n      \x3c!-- Production template--\x3e\n      <div class="uip-flex uip-w-100p" v-else-if="rendered" :class="randomClass">\n        <template v-for="(element, index) in items">\n          \n          <BlockRender :block="element" :list="items" :index="index"/>\n          \n        </template>\n      </div>\n      \n\t\t'};