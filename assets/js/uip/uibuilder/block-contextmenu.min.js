import{defineAsyncComponent}from"../../libs/vue-esm.js";import{validDateTemplate}from"../v3.5/utility/functions.min.js";export default{components:{contextmenu:defineAsyncComponent(()=>import("../v3.5/utility/contextmenu.min.js?ver=3.3.1")),SaveAsPattern:defineAsyncComponent(()=>import("./save-as-pattern.min.js?ver=3.3.1"))},inject:["uiTemplate"],data(){return{block:{},list:null,blockIndex:null,strings:{settings:__("Settings","uipress-lite"),styles:__("Styles","uipress-lite"),delete:__("Delete","uipress-lite"),duplicate:__("Duplicate","uipress-lite"),copy:__("Copy","uipress-lite"),paste:__("Paste","uipress-lite"),editTemplate:__("Edit template","uipress-lite"),resetTemplate:__("Reset template","uipress-lite"),insert:__("Insert","uipress-lite"),loremIpsum:__("Lorem Ipsum","uipress-lite"),autoGenerate:__("Auto generate","uipress-lite"),fromPrompt:__("From prompt","uipress-lite"),editStates:__("Edit states","uipress-lite"),copyStyles:__("Copy styles","uipress-lite")},enabled:{settings:!0,styles:!0,variants:!0,duplicate:!0,copy:!0,copystyles:!0,paste:!0,insert:!0,loremipsum:!0,autogenerate:!0,fromprompt:!0,edittemplate:!0,resettemplate:!0,delete:!0,renameBlock:!0,pastestyles:!0,advanced:!0},links:[{name:"settings",label:__("Settings","uipress-lite"),icon:"tune",action:()=>{this.uipApp.blockSettings.show(this.block,"settings"),this.$refs.blockcontextmenu.close()}},{name:"styles",label:__("Styles","uipress-lite"),icon:"palette",action:()=>{this.uipApp.blockSettings.show(this.block,"style"),this.$refs.blockcontextmenu.close()}},{name:"advanced",label:__("Advanced","uipress-lite"),icon:"code",action:()=>{this.uipApp.blockSettings.show(this.block,"advanced"),this.$refs.blockcontextmenu.close()}},{name:"divider"},{name:"copy",label:__("Copy","uipress-lite"),icon:"chevron_right",action:()=>{},children:[{name:"copyblock",label:__("Block","uipress-lite"),icon:"copy_all",action:()=>{this.uiTemplate.copied=this.block,this.$refs.blockcontextmenu.close()}},{name:"copystyles",label:__("Styles","uipress-lite"),icon:"palette",action:()=>{this.uiTemplate.stylesCopied=this.block.settings,this.$refs.blockcontextmenu.close()}}]},{name:"paste",label:__("Paste","uipress-lite"),icon:"chevron_right",action:()=>{},children:[{name:"pastecontent",label:__("Content","uipress-lite"),icon:"content_paste",condition:()=>!(!this.block.content||!this.uiTemplate.copied),action:()=>{this.pasteBlockContent(),this.$refs.blockcontextmenu.close()}},{name:"pastestyles",label:__("Styles","uipress-lite"),icon:"content_paste",condition:()=>!!this.uiTemplate.stylesCopied,action:()=>{this.pasteStyles(),this.$refs.blockcontextmenu.close()}}]},{name:"duplicate",label:__("Duplicate","uipress-lite"),shortcut:[{type:"icon",value:"keyboard_command_key"},{type:"text",value:"D"}],action:()=>{this.uipApp.blockControl.duplicateBlock(),this.$refs.blockcontextmenu.close()}},{name:"divider"},{name:"saveAsPattern",label:__("Save as pattern","uipress-lite"),icon:"bookmark_add",action:()=>{this.$refs.saveaspattern.show(this.block),this.$refs.blockcontextmenu.close()}},{name:"syncPattern",label:__("Sync pattern","uipress-lite"),icon:"sync",condition:()=>!!this.block.patternID,action:()=>{this.uipApp.blockControl.syncBlockPattern(),this.$refs.blockcontextmenu.close()}},{name:"divider"},{name:"import",label:__("Import","uipress-lite"),icon:"chevron_right",action:()=>{},condition:()=>!!this.block.content,children:[{name:"blockimport",label:__("Block","uipress-lite"),icon:"file_upload",action:()=>{this.importSomething("block"),this.$refs.blockcontextmenu.close()}},{name:"contentimport",label:__("Content","uipress-lite"),icon:"file_upload",action:()=>{this.importSomething("blockcontent"),this.$refs.blockcontextmenu.close()}},{name:"templateimport",label:__("Template","uipress-lite"),icon:"file_upload",action:()=>{this.importSomething("template"),this.$refs.blockcontextmenu.close()}}]},{name:"export",label:__("Export","uipress-lite"),icon:"chevron_right",action:()=>{},children:[{name:"blockexport",label:__("Block","uipress-lite"),icon:"file_download",action:()=>{this.exportStuff("block"),this.$refs.blockcontextmenu.close()}},{name:"contentexport",label:__("Content","uipress-lite"),icon:"file_download",condition:()=>!!this.block.content,action:()=>{this.exportStuff("blockcontent"),this.$refs.blockcontextmenu.close()}},{name:"templateexport",label:__("Template","uipress-lite"),icon:"file_download",action:()=>{this.exportStuff("template"),this.$refs.blockcontextmenu.close()}}]},{name:"divider"},{name:"delete",label:__("Delete","uipress-lite"),shortcut:[{type:"icon",value:"keyboard_command_key"},{type:"icon",value:"backspace"}],danger:!0,action:()=>{this.uipApp.blockControl.deleteBlock(),this.$refs.blockcontextmenu.close()}}]}},created(){this.uipApp.blockcontextmenu=this},computed:{returnBlock(){return this.block},blockTemplateEditable(){let t=this.block.type;return t in this.seqlData.blocks&&this.seqlData.blocks[t].templateEditable}},methods:{show(t){this.block=t.block,this.list=t.list,this.index=t.index,this.$refs.blockcontextmenu.show(t.event),this.uipApp.blockControl.setActive(this.block,this.list,null,!0)},importSomething(t){const e=document.createElement("input");e.type="file",e.accept=".json",e.style.display="none",document.body.appendChild(e);e.addEventListener("change",e=>{const i=e.target.files[0];i&&"application/json"===i.type&&(i.size>1e6||this.importSettings(i,t))}),e.click()},importSettings(t,e){const i=new FileReader;i.readAsText(t,"UTF-8"),i.onload=(t=>{const i=t.target.result;let n;try{n=JSON.parse(i)}catch(t){return void this.uipApp.notifications.notify(t,"","error",!0,!1)}if(n){if(!Array.isArray(n)&&!this.isObject(n))return void this.uipApp.notifications.notify("Template is not valid","","error",!0,!1);let t,i=__("Template imported","uipress-lite");switch(e){case"template":if(Array.isArray(n))t=n;else{if(!n.uipLayout)return this.uipApp.notifications.notify(__("Template mismatch","uipress-lite"),"","error",!0,!1);t=Array.isArray(n.uipLayout)?n.uipLayout:[n.uipLayout]}break;case"block":if(!n.uipLayout)return this.uipApp.notifications.notify(__("Template mismatch","uipress-lite"),"","error",!0,!1);i=__("Block imported","uipress-lite"),t=[n.uipLayout];break;case"blockcontent":if(!n.uipBlockContent)return this.uipApp.notifications.notify(__("Template mismatch","uipress-lite"),"","error",!0,!1);i=__("Content imported","uipress-lite"),t=n.uipBlockContent;break;default:return void console.error("Invalid type provided to importSettings function")}validDateTemplate(t).then(n=>{n.includes(!1)?this.uipApp.notifications.notify(__("File is not a valid JSON template","uipress-lite"),"","error",!0,!1):("template"===e&&(this.uiTemplate.content=t),"block"===e&&this.block.content.push(t[0]),"blockcontent"===e&&(this.block.content=t),this.uipApp.notifications.notify(i,"","success",!0,!1))})}else this.uipApp.notifications.notify(__("JSON parse failed","uipress-lite"),"","error",!0,!1)})},exportStuff(t){let e,i="uip-ui-template-";switch(t){case"template":e=JSON.stringify({uipLayout:this.uiTemplate.content});break;case"block":e=JSON.stringify({uipLayout:this.block}),i="uip-ui-block-";break;case"blockcontent":e=JSON.stringify({uipBlockContent:this.block.content}),i="uip-ui-block-content-";break;default:return void console.error("Invalid type provided to exportStuff function")}const n=this.uiTemplate.globalSettings.name,s=new Date,o=`${i}${n}-${`${s.getMonth()+1}-${s.getDate()}-${s.getFullYear()}`}.json`,l="data:text/json;charset=utf-8,"+encodeURIComponent(e),a=this.$refs.templateexport;a.setAttribute("href",l),a.setAttribute("download",o),a.click();let c=__("Exported","uipress-lite");this.uipApp.notifications.notify(c,"","success",!0)},isEnabled:t=>!t.condition||t.condition(),async pasteStyles(){if(!this.uiTemplate.stylesCopied)return;let t=JSON.parse(JSON.stringify(this.uiTemplate.stylesCopied));for(let e in t)if("advanced"!=e&&"block"!=e&&"container"!=e&&e in this.block.settings){let i=t[e].options;this.block.settings[e]={...this.block.settings[e],...t[e]},this.block.settings[e].options={...this.block.settings[e].options,...i}}},pasteBlockContent(){if(!this.block.content)return;if(!this.uiTemplate.copied)return;JSON.parse(JSON.stringify(this.uiTemplate.content));let t=JSON.parse(JSON.stringify(this.uiTemplate.copied));t.uid=this.createUID(),t.options=[],t.settings=JSON.parse(JSON.stringify(t.settings)),t.content&&(t.content=this.uipApp.blockControl.uniqueIds(t.content)),this.block.content.splice(this.block.content.length,0,t),this.uiTemplate.copied=!1},async canEditBlockTemplates(){return await this.seqlData.permissions.user_can({request:"edit_block_templates",showMessage:!0})},async editTemplate(){await this.canEditBlockTemplates()&&(this.$refs.blockcontextmenu.close(),this.$router.push({query:{...this.$route.query,hasContext:!0}}),this.seqlData.templateeditor.show(this.block))},async editBlockState(){this.$refs.blockcontextmenu.close(),this.seqlData.blockstates.show(this.block,this.list)},async confirmClearTemplate(){await this.canEditBlockTemplates()&&await this.seqlData.confirm.show({title:__("Reset template","uipress-lite"),message:__("Are you sure you want to reset this block's template? Any custom changes to the template will be lost","uipress-lite"),okButton:__("Reset template","uipress-lite")})&&delete this.block._custom_template},returnThisPosition(t){if(!t.currentTarget)return!1;const e=t.currentTarget.getBoundingClientRect();return{clientX:e.right,clientY:e.top}},maybeShowSubMenu(t,e){e.children&&this.$refs[e.name+"menu"][0].show(t,this.returnThisPosition(t))},maybeHideSubMenu(t,e){e.children&&this.$refs[e.name+"menu"][0].close()}},template:'\n  \n\t\t  <contextmenu ref="blockcontextmenu">\n\t  \n\t\t  <div class="uip-padding-xs uip-flex uip-flex-column uip-text-weight-normal uip-text-s">\n\t\t  \n\t\t\t<template v-for="item in links">\n\t\t\t\n\t\t\t\t<div v-if="item.name == \'divider\'" class="uip-border-top uip-margin-top-xxs uip-margin-bottom-xxs"></div>\n\t\t\t\t\n\t\t\t\t<a v-else\n\t\t\t\t@click.prevent="item.action"\n\t\t\t\tclass="uip-link-default uip-padding-xxs uip-border-rounder hover:uip-background-muted uip-no-underline uip-flex uip-flex-center uip-flex-between uip-gap-s"\n\t\t\t\t:class="{ \'uip-link-danger\' : item.danger && isEnabled(item), \'uip-link-disabled\' : !isEnabled(item) }"\n\t\t\t\t@mouseenter="maybeShowSubMenu($event, item)"\n\t\t\t\t@mouseleave="maybeHideSubMenu($event, item)">\n\t\t\t\t\n\t\t\t\t  <span class="">{{item.label}}</span>\n\t\t\t\t  \n\t\t\t\t  <span v-if="item.icon" class="uip-flex-no-shrink uip-icon" \n\t\t\t\t  :class="{ \'uip-link-muted\' : !item.danger }">{{item.icon}}</span>\n\t\t\t\t  \n\t\t\t\t  <span v-if="item.shortcut" class="uip-flex uip-flex-center uip-gap-xxxs uip-opacity-50">\n\t\t\t\t\t<template v-for="cut in item.shortcut">\n\t\t\t\t\t  <span v-if="cut.type==\'icon\'" class="uip-icon">{{cut.value}}</span>\n\t\t\t\t\t  <span v-if="cut.type==\'text\'" class="uip-text-s">{{ cut.value }}</span>\n\t\t\t\t\t</template>\n\t\t\t\t  </span>\n\t\t\t\t  \n\t\t\t\t  \n\t\t\t\t  \x3c!-- Submenu --\x3e\n\t\t\t\t  \n\t\t\t\t  <contextmenu v-if="item.children" :ref="item.name + \'menu\'" :disableTeleport="true">\n\t\t\t\t\t  \n\t\t\t\t\t  \n\t\t\t\t\t\t<div class="uip-padding-xs uip-flex uip-flex-column uip-text-weight-normal uip-min-w-130">\n\t\t\t\t\t\t\n\t\t\t\t\t\t  <template v-for="subitem in item.children">\n\t\t\t\t\t\t  \n\t\t\t\t\t\t\t<a\n\t\t\t\t\t\t\tclass="uip-link-default uip-padding-xxs uip-border-rounder hover:uip-background-muted uip-no-underline uip-flex uip-flex-center uip-flex-between uip-gap-s"\n\t\t\t\t\t\t\t@click.prevent="subitem.action"\n\t\t\t\t\t\t\t:class="{ \'uip-link-danger\' : item.danger && isEnabled(subitem), \'uip-link-disabled\' : !isEnabled(subitem) }"\n\t\t\t\t\t\t\ttype="menuLink">\n\t\t\t\t\t\t\t  \n\t\t\t\t\t\t\t  <span class="">{{subitem.label}}</span>\n\t\t\t\t\t\t\t  <span class="uip-flex-no-shrink uip-text-muted uip-icon">{{ subitem.icon }}</span>\n\t\t\t\t\t\t\t  \n\t\t\t\t\t\t\t</a>  \n\t\t\t\t\t\t  \n\t\t\t\t\t\t  </template>\n\t\t\t\t\t\t\n\t\t\t\t\t\t</div>\n\t\t\t\t\t  \n\t\t\t\t  </contextmenu>\n\t\t\t\t\n\t\t\t\t</a>\n\t\t\t\n\t\t\t</template>\n\t\t  \n\t\t  \n\t\t  </div>\n\t  \n\t      \n\t\t\t  \n\t\t</contextmenu>\n    \n        <a ref="templateexport" href="" style="display:none;"></a>\n    \n        <SaveAsPattern ref="saveaspattern"/>\n\t\t  \n\t\n\t\t'};